"use strict";const e=require("electron").protocol,r=require("fire-url"),t=require("fire-fs"),o=require("querystring");function i(e){let r=e.hostname;return Editor.assetdb.uuidToFspath(r)}function d(e){return Editor.assetdb._fspath(e.href)}let s=e.registerFileProtocol("uuid",(e,t)=>{let o=decodeURIComponent(e.url);t({path:i(r.parse(o))})});s?Editor.success("protocol uuid registerred"):Editor.failed("Failed to register protocol uuid"),Editor.Protocol.register("uuid",i),(s=e.registerFileProtocol("db",(e,r)=>{r({path:d(decodeURIComponent(e.url))})}))?Editor.success("protocol db registerred"):Editor.failed("Failed to register protocol uuid"),Editor.Protocol.register("db",d),(s=e.registerBufferProtocol("thumbnail",(e,d)=>{let s=decodeURIComponent(e.url),u=r.parse(s),a=i(u);if(!t.existsSync(a))return d(-6),void 0;let l,n=parseInt(u.query)||32;l=Editor.dev?"sharp":Editor.url("unpack://utils/sharp");const c=require(l);var p=/\.jpg$/.test(a);p&&c.cache(!1);let h=c(a),f=o.parse(u.query);if(f){let e=function(e){return e&&void 0!==e.x&&void 0!==e.y&&void 0!==e.w&&void 0!==e.h?{left:parseInt(e.x),top:parseInt(e.y),width:parseInt(e.w),height:parseInt(e.h)}:null}(f);e&&h.extract(e),f.rotate&&h.rotate(parseInt(f.rotate))}h.resize({width:n,height:n,background:{r:255,g:255,b:255,alpha:0}}).toFormat(c.format.png).toBuffer((e,r)=>{if(p&&c.cache(!0),e)return d(-6),void 0;d({mimeType:"image/png",data:r})})}))?Editor.success("protocol thumbnail registerred"):Editor.failed("Failed to register protocol thumbnail");