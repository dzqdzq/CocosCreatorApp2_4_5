"use strict";const e=require("../lib/sandbox"),n=require("../lib/tasks"),t=require("../utils/prefab"),o={scene:require("./modes/scene"),animation:require("./modes/animation"),prefab:require("./modes/prefab")},r=[o.scene];let s=function(){return r[r.length-1]},i=function(o,i,l){i=i||{};n.push({name:`pop-edit-mode:[${o}]`,run:async function(l){let u=!0;if(void 0!==i.closeResult&&(u=!1),1===r.length)return l();if(e.reloading)return l(new Error("Can not change editmode when scripts are reloading, try again please."));let a=s();return o&&o!==a.name?l(new Error(`Pop mode [${o}] not match current mode [${a.name}]`)):(await t.confirmEditingPrefabSynced(),u&&(i.closeResult=a.confirmClose()),1===i.closeResult?(n.kill(),l(null,1)):(a.close(i.closeResult,e=>{if(1===r.length)return;r.pop();let n=r[r.length-1];Editor.Ipc.sendToPanel("scene","scene:update-edit-mode",{title:n.title,name:n.name}),l(e,i.closeResult)}),void 0))}},l)},l=function(){for(let e=r.length-1;e>0;e--)i(r[e].name)},u=function(e,t){e=e||{};n.push({name:"close-scene",run:function(n){let t=!0;void 0!==e.closeResult?t=!1:e.closeResult=2,t&&(e.closeResult=o.scene.confirmClose()),o.scene.close(e.closeResult,(e,t)=>{e&&Editor.error(e),n&&n(e,t)})}},(e,n)=>{1!==n&&t&&t(e,n)})};module.exports={push:function(e,t,i){n.push({name:`push-edit-mode:[${e}]`,run:function(l){let u=o[e];if(!u)return cb(new Error(`Can't find register for mode name [${e}]`));t=t||[],i=i||function(){},Array.isArray(t)||(t=[t]);let a=s();n.stash(),a.beforePushOther&&a.beforePushOther(u,...t),n.push({name:`open-edit-mode:[${u.name}]`,run(e){u.open(...t,()=>{r.push(u),Editor.Ipc.sendToPanel("scene","scene:update-edit-mode",{title:u.title,name:u.name}),e()})}},i),n.unshiftStash(),l()}},i)},pop:i,popAll:l,close:function(e){l(),u({},e)},closeScene:u,softReload:function(){for(let e=r.length-1;e>=0;e--){let n=r[e];if(n&&n.softReload&&!1===n.softReload())break}},title:function(){let e=s();return e===o.scene?"":e.title},curMode:s,save:function(e){let t=s();n.push({name:`save-editor-mode:[${t.name}]`,run:function(e){t.save(n=>{if(n)return Editor.error(n.message),e(n);_Scene.stashScene(()=>{Editor.Profile.load("global://settings.json").get("auto-refresh")&&Editor.Ipc.sendToMain("app:reload-on-device"),e()})})}},e)},dirtyMode:function(){for(let e=r.length-1;e>=0;e--){let n=r[e];if(n.dirty())return n}return null}};