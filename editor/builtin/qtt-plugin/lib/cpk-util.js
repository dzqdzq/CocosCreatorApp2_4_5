let e=require("./jszip.min.js"),t=require("path"),i=require("fs-extra"),n=require("./adapter-util.js"),o=require("./tinypack-util.js"),r={};e.prototype.directory=function(e,n){if(!i.statSync(e).isDirectory())return Editor.error(e+" is not a folder!"),void 0;i.readdirSync(e).forEach(function(e){let n=this.zip,o=t.join(this.srcPath,e),r=i.statSync(o);r.isDirectory()?n.directory(o,e):r.isFile()?n.file(e,i.readFileSync(o)):Editor.error(o+" was not added to zip!")}.bind({srcPath:e,zip:this.folder(n)}))},e.prototype.append=function(e,t){if(!i.statSync(e).isFile())return Editor.error(e+" is not a file!"),void 0;this.file(t,i.readFileSync(e))},module.exports={async gatherInfo(a,s){if(r.customConfig=Editor.Profile.load("project://qtt-runtime.json").getSelfData(),!1===this.checkData(r,s,a))return!1;let c=r.customConfig;r.isTinyPackage=""!==c.tinyPackageServer,r.projectPath=a.project,r.buildPath=a.dest,r.options=a,r.title=a.title,r.cpkName=r.customConfig.package+"_"+r.customConfig.versionName+"_"+r.customConfig.versionCode+".cpk";let m=c.outputCpkPath,u=c.useCustomCpkPath;return r.buildResults=a.buildResults,r.startScene=a.startScene,!0===u?""!==m&&i.existsSync(m)?r.cpkPath=t.join(m,r.cpkName):(Editor.log(Editor.T("qtt-runtime.out_cpk_path_error")),r.cpkPath=t.join(r.buildPath,r.cpkName)):r.cpkPath=t.join(r.buildPath,r.cpkName),r.gameConfig={deviceOrientation:c.deviceOrientation,showStatusBar:c.showStatusBar,runtimeVersion:c.runtimeVersion},r.mainfest={deviceOrientation:c.deviceOrientation,package:c.package,name:c.name,versionName:c.versionName,versionCode:c.versionCode,icon:"logo.png"},r.JsZip=e,r.cpk=new e,await n.gatherInfo(r),await o.gatherInfo(r),!0},checkData(e,n,o){var r=e.customConfig.package,a=e.customConfig.name,s=e.customConfig.versionName,c=e.customConfig.versionCode,m=e.customConfig.icon,u=!0,d=[],p="";[{name:Editor.T("qtt-runtime.package"),value:r},{name:Editor.T("qtt-runtime.name"),value:a},{name:Editor.T("qtt-runtime.desktop_icon"),value:m},{name:Editor.T("qtt-runtime.version_name"),value:s},{name:Editor.T("qtt-runtime.version_number"),value:c}].forEach(function(e){e.value||(u=!1,d.push(e.name))}),u||(p+=d.join("„ÄÅ")+Editor.T("qtt-runtime.not_empty")),m&&(i.existsSync(m)||(u=!1,p+=m+Editor.T("qtt-runtime.icon_not_exist")));r.match(/^[a-zA-Z]+[0-9a-zA-Z]*(\.[a-zA-Z]+[0-9a-zA-Z]*)*$/)||(u=!1,p+=Editor.T("qtt-runtime.package_name_error"));a.match(/^[0-9a-zA-Z]*(\.[a-zA-Z]+[0-9a-zA-Z]*)*$/)||(u=!1,p+=Editor.T("qtt-runtime.game_name_error"));s.match(/^[0-9]*(\.[0-9]*)*$/)||(p+=Editor.T("qtt-runtime.game_version_name_error"));return c.match(/^[1-9]+[0-9]*]*$/)||(p+=Editor.T("qtt-runtime.game_version_number_error")),u?(i.existsSync(t.join(o.dest,"remote"))&&""===e.customConfig.tinyPackageServer&&Editor.warn(Editor.T("qtt-runtime.had_set_remote_without_tiny_mode")),!0):(n.reply(new Error(p)),!1)},async organizeResources(e){let o=r.buildPath;return!1!==await n.organizeResources(e)&&(i.writeJSONSync(t.join(o,"game.config.json"),r.gameConfig),i.writeJSONSync(t.join(o,"manifest.json"),r.mainfest),!0)},async pack(e){let a=r.cpk,s=r.cpkPath,c=r.buildPath;i.existsSync(s)&&i.unlinkSync(s),await n.pack(),await o.pack(),a.directory(t.join(c,"src"),"src"),a.directory(t.join(c,"assets"),"assets"),a.append(r.customConfig.icon,"logo.png"),a.append(t.join(c,"main.js"),"main.js"),a.append(t.join(c,"game.config.json"),"game.config.json"),a.append(t.join(c,"manifest.json"),"manifest.json"),a.generateAsync({type:"nodebuffer",base64:!1,compression:"DEFLATE"}).then(function(t){i.writeFileSync(s,t),e.reply()})}};