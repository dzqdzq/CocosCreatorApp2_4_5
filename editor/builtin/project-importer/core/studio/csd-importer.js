"use strict";const e=require("async"),t=require("xmldom").DOMParser,r=require("fire-fs"),o=require("fire-path"),n=require("fire-url"),i=require("./xml-utils"),a="db://internal/",d="db://internal/image/default_sprite_splash.png/default_sprite_splash",l="db://internal/particle/atom.plist",c="db://internal/image/default_btn_normal.png/default_btn_normal",f="db://internal/image/default_btn_pressed.png/default_btn_pressed",s="db://internal/image/default_btn_disabled.png/default_btn_disabled",p="db://internal/image/default_progressbar.png/default_progressbar",g="db://internal/image/default_scrollbar_vertical.png/default_scrollbar_vertical",u="db://internal/image/default_scrollbar.png/default_scrollbar",m="db://internal/image/default_panel.png/default_panel",N="_action",y=60,v=/[\\\/]/g,h={SpriteObjectData:function(e,t,r){Y(e,t,cc.Sprite.SizeMode.RAW,r)},ImageViewObjectData:function(t,r,o){e.waterfall([function(e){Y(t,r,cc.Sprite.SizeMode.CUSTOM,e)},function(e){var o=t.getComponent(cc.Sprite);if(!o)return e(),void 0;var n=i.getBoolPropertyOfNode(r,"Scale9Enable",!1);n&&o.spriteFrame?(o.type=cc.Sprite.Type.SLICED,W(r,o.spriteFrame._uuid,e)):e()}],o)},ParticleObjectData:function(e,t,r){var o=e.addComponent(cc.ParticleSystem);if(!o)return Editor.warn("Add ParticleSystem component for node %s failed.",t.getAttribute("Name")),r(),void 0;var a="";switch(i.getPropertyOfNode(t,"Type","Default","FileData")){case"Normal":var d=i.getPropertyOfNode(t,"Path","","FileData");a=n.join(B,d);break;case"Default":default:a=l}if(a){var c=Editor.assetdb.remote.urlToUuid(a);Editor.assetdb.remote.existsByUuid(c)&&(o.file=Editor.assetdb.remote._fspath(a),o.custom=!1)}r()},GameMapObjectData:function(e,t,r){var o=e.addComponent(cc.TiledMap);if(!o)return Editor.warn("Add TiledMap component for node %s failed.",t.getAttribute("Name")),r(),void 0;var a="";switch(i.getPropertyOfNode(t,"Type","Default","FileData")){case"Normal":var d=i.getPropertyOfNode(t,"Path","","FileData");a=n.join(B,d)}if(a){var l=Editor.assetdb.remote.urlToUuid(a);Editor.assetdb.remote.existsByUuid(l)&&(o.tmxFile=Editor.assetdb.remote._fspath(a))}r()},SimpleAudioObjectData:function(e,t,r){var o=e.addComponent(cc.AudioSource);if(!o)return Editor.warn("Add AudioSource component for node %s failed.",t.getAttribute("Name")),r(),void 0;var a="";switch(i.getPropertyOfNode(t,"Type","Default","FileData")){case"Normal":var d=i.getPropertyOfNode(t,"Path","","FileData");a=n.join(B,d)}if(a){var l=Editor.assetdb.remote.urlToUuid(a);Editor.assetdb.remote.existsByUuid(l)&&(o.clip=Editor.assetdb.remote._fspath(a))}r()},ButtonObjectData:function(t,r,o){var n=t.addComponent(cc.Button),a=t.addComponent(cc.Sprite);if(!n)return Editor.warn("Add Button component for node %s failed.",r.getAttribute("Name")),o(),void 0;a.sizeMode=cc.Sprite.SizeMode.CUSTOM,a.trim=!1;var d=i.getBoolPropertyOfNode(r,"Scale9Enable",!1);d&&(a.type=cc.Sprite.Type.SLICED);n.interactable=i.getBoolPropertyOfNode(r,"DisplayState",!0),n.transition=cc.Button.Transition.SPRITE;var l=i.getFirstChildNodeByName(r,"NormalFileData");a.spriteFrame=X(l,c),n.normalSprite=X(l,c),n.hoverSprite=X(l,c);var p=i.getFirstChildNodeByName(r,"PressedFileData");n.pressedSprite=X(p,f);var g=i.getFirstChildNodeByName(r,"DisabledFileData");n.disabledSprite=X(g,s);var u=i.getPropertyOfNode(r,"ButtonText","");if(u){var m=new cc.Node("Label");m.setContentSize(t.getContentSize()),t.addChild(m);var N=m.addComponent(cc.Label),y=i.getIntPropertyOfNode(r,"FontSize",14),v=new cc.Color(i.getIntPropertyOfNode(r,"R",65,"TextColor"),i.getIntPropertyOfNode(r,"G",65,"TextColor"),i.getIntPropertyOfNode(r,"B",70,"TextColor")),h=i.getIntPropertyOfNode(r,"A",255,"TextColor");m.color=v,m.opacity=h,N.string=u,N._fontSize=y,N.horizontalAlign=cc.Label.HorizontalAlign.CENTER,N.verticalAlign=cc.Label.VerticalAlign.CENTER;var P=m.addComponent(cc.StudioWidget);P.isAlignVerticalCenter=!0,P.isAlignHorizontalCenter=!0;var C=i.getFirstChildNodeByName(r,"FontResource");C&&Z(N,C)}if(d){for(var O=[n.normalSprite,n.pressedSprite,n.disabledSprite],S=[],b=0,F=O.length;b<F;b++){var A=O[b];A&&(S.indexOf(A._uuid)<0&&S.push(A._uuid))}if(0===S.length)return o(),void 0;var B=0;e.whilst(function(e){e(null,B<S.length)},function(e){W(r,S[B],function(){B++,e()})},function(){o()})}else o()},TextBMFontObjectData:G,TextObjectData:G,LoadingBarObjectData:function(e,t,r){var o=e.addComponent(cc.Sprite),n=e.addComponent(cc.ProgressBar);if(!n)return Editor.warn("Add ProgressBar component for node %s failed.",t.getAttribute("Name")),r(),void 0;n.mode=cc.ProgressBar.Mode.FILLED;var a=i.getPropertyOfNode(t,"ProgressType","");n.reverse="Right_To_Left"===a,o.sizeMode=cc.Sprite.SizeMode.CUSTOM,o.trim=!1;var d=i.getFirstChildNodeByName(t,"ImageFileData");o.spriteFrame=X(d,p),o.type=cc.Sprite.Type.FILLED,o.fillType=cc.Sprite.FillType.HORIZONTAL,o.fillStart=n.reverse?1:0,n.barSprite=o,n.totalLength=1;var l=i.getIntPropertyOfNode(t,"ProgressInfo",80);n.progress=l/100,r()},TextFieldObjectData:function(e,t,r){var o=e.addComponent(cc.EditBox);if(!o)return Editor.warn("Add EditBox component for node %s failed.",t.getAttribute("Name")),r(),void 0;o._useOriginalSize=!1,o.lineHeight=0,o.placeholder=i.getPropertyOfNode(t,"PlaceHolderText",""),o.string=i.getPropertyOfNode(t,"LabelText",""),o.fontColor=new cc.Color(i.getIntPropertyOfNode(t,"R",255,"CColor"),i.getIntPropertyOfNode(t,"G",255,"CColor"),i.getIntPropertyOfNode(t,"B",255,"CColor"),i.getIntPropertyOfNode(t,"A",255,"CColor")),o.fontSize=i.getIntPropertyOfNode(t,"FontSize",20),i.getBoolPropertyOfNode(t,"MaxLengthEnable",!1)?o.maxLength=i.getIntPropertyOfNode(t,"MaxLengthText",10):o.maxLength=-1;i.getBoolPropertyOfNode(t,"PasswordEnable",!1)&&(o.inputFlag=cc.EditBox.InputFlag.PASSWORD,o.inputMode=cc.EditBox.InputMode.SINGLE_LINE);r()},PanelObjectData:J,CheckBoxObjectData:function(e,t,r){var o=e.addComponent(cc.StudioComponent);if(!o)return Editor.warn("Add StudioComponent component for node %s failed.",t.getAttribute("Name")),r(),void 0;o.type=cc.StudioComponent.ComponentType.CHECKBOX;var n=i.getFirstChildNodeByName(t,"NormalBackFileData");o.checkNormalBackFrame=X(n,"");var a=i.getFirstChildNodeByName(t,"PressedBackFileData");o.checkPressedBackFrame=X(a,"");var d=i.getFirstChildNodeByName(t,"DisableBackFileData");o.checkDisableBackFrame=X(d,"");var l=i.getFirstChildNodeByName(t,"NodeNormalFileData");o.checkNormalFrame=X(l,"");var c=i.getFirstChildNodeByName(t,"NodeDisableFileData");o.checkDisableFrame=X(c,""),o.checkInteractable=i.getBoolPropertyOfNode(t,"DisplayState",!0),o.isChecked=i.getBoolPropertyOfNode(t,"CheckedState",!1),r()},TextAtlasObjectData:function(e,t,r){var o=e.addComponent(cc.StudioComponent);if(!o)return Editor.warn("Add StudioComponent component for node %s failed.",t.getAttribute("Name")),r(),void 0;o.type=cc.StudioComponent.ComponentType.TEXT_ATLAS;var n=i.getFirstChildNodeByName(t,"LabelAtlasFileImage_CNB");o.atlasFrame=X(n,""),o.firstChar=i.getPropertyOfNode(t,"StartChar","."),o.charWidth=i.getIntPropertyOfNode(t,"CharWidth",0),o.charHeight=i.getIntPropertyOfNode(t,"CharHeight",0),o.string=i.getPropertyOfNode(t,"LabelText",""),r()},SliderObjectData:function(e,t,r){var o=e.addComponent(cc.StudioComponent);if(!o)return Editor.warn("Add StudioComponent component for node %s failed.",t.getAttribute("Name")),r(),void 0;o.type=cc.StudioComponent.ComponentType.SLIDER_BAR;var n=i.getFirstChildNodeByName(t,"BackGroundData");o.sliderBackFrame=X(n,"");var a=i.getFirstChildNodeByName(t,"ProgressBarData");o.sliderBarFrame=X(a,"");var d=i.getFirstChildNodeByName(t,"BallNormalData");o.sliderBtnNormalFrame=X(d,"");var l=i.getFirstChildNodeByName(t,"BallPressedData");o.sliderBtnPressedFrame=X(l,"");var c=i.getFirstChildNodeByName(t,"BallDisabledData");o.sliderBtnDisabledFrame=X(c,""),o.sliderInteractable=i.getBoolPropertyOfNode(t,"DisplayState",!0);var f=i.getIntPropertyOfNode(t,"PercentInfo",0);o.sliderProgress=f/100,r()},ListViewObjectData:function(e,t,r){var o=e.addComponent(cc.StudioComponent);if(!o)return Editor.warn("Add StudioComponent component for node %s failed.",t.getAttribute("Name")),r(),void 0;if(o.type=cc.StudioComponent.ComponentType.LIST_VIEW,o.listInertia=i.getBoolPropertyOfNode(t,"IsBounceEnabled",!1),"Vertical"===i.getPropertyOfNode(t,"DirectionType","")){o.listDirection=cc.StudioComponent.ListDirection.VERTICAL;let e=i.getPropertyOfNode(t,"HorizontalType","Left");e.indexOf("Center")>=0?o.listHorizontalAlign=cc.StudioComponent.HorizontalAlign.CENTER:e.indexOf("Right")>=0?o.listHorizontalAlign=cc.StudioComponent.HorizontalAlign.RIGHT:o.listHorizontalAlign=cc.StudioComponent.HorizontalAlign.LEFT}else{o.listDirection=cc.StudioComponent.ListDirection.HORIZONTAL;let e=i.getPropertyOfNode(t,"VerticalType","Top");e.indexOf("Center")>=0?o.listVerticalAlign=cc.StudioComponent.VerticalAlign.CENTER:e.indexOf("Bottom")>=0?o.listVerticalAlign=cc.StudioComponent.VerticalAlign.BOTTOM:o.listVerticalAlign=cc.StudioComponent.VerticalAlign.TOP}o.listPadding=i.getIntPropertyOfNode(t,"ItemMargin",0),J(e,t,r)},PageViewObjectData:function(e,t,r){var o=e.addComponent(cc.StudioComponent);if(!o)return Editor.warn("Add StudioComponent component for node %s failed.",t.getAttribute("Name")),r(),void 0;o.type=cc.StudioComponent.ComponentType.PAGE_VIEW,J(e,t,r)}},P={ProjectNodeObjectData:function(t,r){var a=i.getPropertyOfNode(t,"Path","","FileData"),d=o.join(E,a),l=null;e.waterfall([function(e){w(d,e)},function(e){var t=function(e,t){var r=o.dirname(e),i=o.relative(E,r),a=o.basename(e,o.extname(e));return n.join(B,i,a+t)}(d,".prefab"),r=Editor.assetdb.remote.urlToUuid(t);if(!r)return e(),void 0;cc.assetManager.loadAny(r,function(t,r){t?e():(l=cc.instantiate(r),e())})}],function(){l||(l=new cc.Node),r(l)})},ScrollViewObjectData:function(t,r){var o=new cc.Node(x(t.getAttribute("Name")));U(o,t);var n=o.addComponent(cc.ScrollView);if(!n)return Editor.warn("Add ScrollView component for node %s failed.",t.getAttribute("Name")),r(o),void 0;n.inertia=i.getBoolPropertyOfNode(t,"IsBounceEnabled",!1);var a=i.getPropertyOfNode(t,"ScrollDirectionType","Vertical");if(n.vertical=a.indexOf("Vertical")>=0,n.horizontal=a.indexOf("Horizontal")>=0,i.getBoolPropertyOfNode(t,"ClipAble",!1)){var d=o.addComponent(cc.Mask);d.enabled=!0}var l=o.getContentSize().width,c=o.getContentSize().height,f=new cc.Node("content"),s=i.getIntPropertyOfNode(t,"Width",l,"InnerNodeSize"),p=i.getIntPropertyOfNode(t,"Height",c,"InnerNodeSize");f.setContentSize(s,p),f.setAnchorPoint(0,1),f.setPosition(0,c),e.waterfall([function(e){K(o,t,e)},function(e){if(o.addChild(f),f.setPosition(k(f)),n.content=f,n.vertical){var t=Q(cc.Scrollbar.Direction.VERTICAL,"vScrollBar",o.getContentSize());o.addChild(t),n.verticalScrollBar=t.getComponent(cc.Scrollbar)}if(n.horizontal){var r=Q(cc.Scrollbar.Direction.HORIZONTAL,"hScrollBar",o.getContentSize());o.addChild(r),n.horizontalScrollBar=r.getComponent(cc.Scrollbar)}e()}],function(){r(f,o)})}},C=["GameLayerObjectData","GameNodeObjectData"],O={AnchorPoint:function(e,t){t=j(t);for(var r=[],o=[],n=i.getAllChildren(e),a=0,d=n.length;a<d;a++){var l=n[a],c=i.getIntPropertyOfNode(l,"FrameIndex",0),f=i.getFloatPropertyOfNode(l,"X",0),s=i.getFloatPropertyOfNode(l,"Y",0),p={frame:c,value:f},g={frame:c,value:s},u=H(l);u&&(p.curve=u,g.curve=u),r.push(p),o.push(g)}return t.props.anchorX=r,t.props.anchorY=o,t},Position:function(e,t,r){t=j(t);for(var o=[],n=i.getAllChildren(e),a=0,d=n.length;a<d;a++){var l=n[a],c=i.getIntPropertyOfNode(l,"FrameIndex",0),f=i.getFloatPropertyOfNode(l,"X",0),s=i.getFloatPropertyOfNode(l,"Y",0),p=k(r,cc.v2(f,s)),g={frame:c,value:[p.x,p.y]},u=H(l);u&&(g.curve=u),o.push(g)}return t.props.position=o,t},RotationSkew:function(e,t){t=j(t);for(var r=[],o=i.getAllChildren(e),n=0,a=o.length;n<a;n++){var d=o[n],l=i.getIntPropertyOfNode(d,"FrameIndex",0),c=i.getFloatPropertyOfNode(d,"X",0),f={frame:l,value:c},s=H(d);s&&(f.curve=s),r.push(f)}return t.props.rotation=r,t},Scale:function(e,t){t=j(t);for(var r=[],o=[],n=i.getAllChildren(e),a=0,d=n.length;a<d;a++){var l=n[a],c=i.getIntPropertyOfNode(l,"FrameIndex",0),f=i.getFloatPropertyOfNode(l,"X",0),s=i.getFloatPropertyOfNode(l,"Y",0),p={frame:c,value:f},g={frame:c,value:s},u=H(l);u&&(p.curve=u,g.curve=u),r.push(p),o.push(g)}return t.props.scaleX=r,t.props.scaleY=o,t},CColor:function(e,t){t=j(t);for(var r=[],o=i.getAllChildren(e),n=0,a=o.length;n<a;n++){var d=o[n],l=i.getIntPropertyOfNode(d,"FrameIndex",0),c={frame:l,value:new cc.Color(i.getIntPropertyOfNode(d,"R",255,"Color"),i.getIntPropertyOfNode(d,"G",255,"Color"),i.getIntPropertyOfNode(d,"B",255,"Color"),255)},f=H(d);f&&(c.curve=f),r.push(c)}return t.props.color=r,t},Alpha:function(e,t){t=j(t);for(var r=[],o=i.getAllChildren(e),n=0,a=o.length;n<a;n++){var d=o[n],l=i.getIntPropertyOfNode(d,"FrameIndex",0),c={frame:l,value:i.getIntPropertyOfNode(d,"Value",255)},f=H(d);f&&(c.curve=f),r.push(c)}return t.props.opacity=r,t},VisibleForFrame:function(e,t){t=j(t);for(var r=[],o=i.getAllChildren(e),n=0,a=o.length;n<a;n++){var d=o[n],l=i.getIntPropertyOfNode(d,"FrameIndex",0),c={frame:l,value:i.getBoolPropertyOfNode(d,"Value",!0)};r.push(c)}return t.props.active=r,t},FileData:function(e,t,r){if(!r)return t;if(r.getComponent(cc.Sprite)){t=function(e,t){e||(e={});e.comps||(e.comps={});e.comps[t]||(e.comps[t]={});return e}(t,"cc.Sprite");for(var o=[],n=i.getAllChildren(e),a=0,d=n.length;a<d;a++){var l=n[a],c=i.getIntPropertyOfNode(l,"FrameIndex",0),f=i.getFirstChildNodeByName(l,"TextureFile"),s=X(f,"");if(s){var p={frame:c,value:s};o.push(p)}}t.comps["cc.Sprite"].spriteFrame=o}return t}},S=["sine","quad","cubic","quart","quint","expo","circ","elastic","back","bounce"],b=["In","Out","InOut"],F="triggerAnimationEvent";var A=[],B="",I="",E="",T={};function w(a,d){if(A.indexOf(a)>=0)return d(),void 0;if(Editor.log("Importing csd file : ",a),!r.existsSync(a))return Editor.warn("%s is not existed!",a),d(),void 0;if(!r.statSync(a).isFile())return Editor.warn("%s is not a file!",a),d(),void 0;var l=(new t).parseFromString(r.readFileSync(a,"utf-8"));if(!l)return Editor.warn("Parse %s failed.",a),d(),void 0;try{var c=l.getElementsByTagName("PropertyGroup")[0].getAttribute("Type"),f=l.getElementsByTagName("Content")[0];f=i.getFirstChildNodeByName(f,"Content")}catch(e){return Editor.warn("Parse %s failed.",a),d(),void 0}if(!f||!c)return Editor.warn("Parse %s failed.",a),d(),void 0;var s=null,p=null;switch(c){case"Scene":s=D(a,".fire"),p=z;break;case"Node":case"Layer":s=D(a,".prefab"),p=L}if(!p)return d(),void 0;e.waterfall([function(e){T={},p(f,a,function(t){if(t){var n=o.dirname(s);r.existsSync(n)||r.mkdirsSync(n),r.writeFileSync(s,t)}e()})},function(e){var t=o.relative(I,s),r=n.join(B,t);Editor.assetdb.import([s],n.dirname(r),!1,function(t,r){A.push(a),e()})}],d)}function D(e,t){var r=o.dirname(e),n=o.relative(E,r),i=o.basename(e,o.extname(e));return o.join(I,n,i+t)}function x(e){var t=e;return e&&(t=e.replace(v,"_"))!==e&&Editor.warn('The name of node "%s" contains illegal characters. It was renamed to "%s".',e,t),t}function z(e,t,r){var o=new cc.SceneAsset,n=new cc.Scene,i=new cc.Node("Scene");i.setAnchorPoint(0,0),n.addChild(i);var a=new cc.Node("Canvas");a.addComponent(cc.Canvas),i.addChild(a);var d=new cc.Node("Main Camera");d.addComponent(cc.Camera),a.addChild(d),_(i,e,t,function(){o.scene=n,r(Editor.serialize(o))})}function L(e,t,r){var o=new cc.Node;_(o,e,t,function(){var e=Editor.require("scene://utils/prefab").createPrefabFrom(o);r(Editor.serialize(e))})}function _(t,a,d,l){e.waterfall([function(r){var o=i.getFirstChildNodeByName(a,"ObjectData");(function t(r,o,n,a){var d=r;var l=!1;var c="";e.waterfall([function(e){if(r)e();else{l=!0;var t=o.getAttribute("ctype"),n=P[t];n?n(o,function(t,o){r=t,d=o||r,e()}):(r=new cc.Node,d=r,e())}},function(e){if(l){var t=i.getPropertyOfNode(o,"ActionTag","");t&&(n&&(c+=n+"/"),c+=x(o.getAttribute("Name")),T[t]={nodePath:c,node:d})}(function(e,t,r){var o=t.getAttribute("ctype");"ScrollViewObjectData"!==o&&U(e,t);e.active=i.getBoolPropertyOfNode(t,"VisibleForFrame",!0),i.getBoolPropertyOfNode(t,"TouchEnable",!1)&&e.addComponent(cc.BlockInputEvents);(function(e,t){var r=i.getPropertyOfNode(t,"HorizontalEdge",""),o=i.getBoolPropertyOfNode(t,"PercentWidthEnable",!1),n=i.getBoolPropertyOfNode(t,"PercentWidthEnabled",!1),a=i.getBoolPropertyOfNode(t,"PositionPercentXEnabled",!1),d=i.getBoolPropertyOfNode(t,"StretchWidthEnable",!1),l=i.getFloatPropertyOfNode(t,"X",0,"PrePosition");a&&(a=0!==l);var c=i.getPropertyOfNode(t,"VerticalEdge",""),f=i.getBoolPropertyOfNode(t,"PercentHeightEnable",!1),s=i.getBoolPropertyOfNode(t,"PercentHeightEnabled",!1),p=i.getBoolPropertyOfNode(t,"PositionPercentYEnabled",!1),g=i.getBoolPropertyOfNode(t,"StretchHeightEnable",!1),u=i.getFloatPropertyOfNode(t,"Y",0,"PrePosition");if(p&&(p=0!==u),r||o||n||a||d||c||f||s||p||g){var m=e.addComponent(cc.StudioWidget);if(!m)return Editor.warn("Add Widget component for node %s failed.",t.getAttribute("Name")),void 0;var N=e.getAnchorPoint(),y=i.getFloatPropertyOfNode(t,"X",0,"PreSize"),v=i.getFloatPropertyOfNode(t,"LeftMargin",0),h=i.getFloatPropertyOfNode(t,"RightMargin",0),P=l-y*N.x,C=1-l-y*(1-N.x),O=o||n||d;r.indexOf("Left")>=0?(E(!a),O&&T(!1)):r.indexOf("Right")>=0?(T(!a),O&&E(!1)):r.indexOf("Both")>=0?(E(!O&&!a),T(!O&&!a)):O?(E(!1),T(!1)):a&&E(!1);var S=i.getFloatPropertyOfNode(t,"Y",0,"PreSize"),b=i.getFloatPropertyOfNode(t,"TopMargin",0),F=i.getFloatPropertyOfNode(t,"BottomMargin",0),A=u-S*N.y,B=1-u-S*(1-N.y),I=f||s||g;c.indexOf("Bottom")>=0?(w(!p),I&&D(!1)):c.indexOf("Top")>=0?(D(!p),I&&w(!1)):c.indexOf("Both")>=0?(w(!I&&!p),D(!I&&!p)):p&&w(!1)}function E(e){m.isAlignLeft=!0,m.isAbsoluteLeft=e,m.left=e?v:P}function T(e){m.isAlignRight=!0,m.isAbsoluteRight=e,m.right=e?h:C}function w(e){m.isAlignBottom=!0,m.isAbsoluteBottom=e,m.bottom=e?F:A}function D(e){m.isAlignTop=!0,m.isAbsoluteTop=e,m.top=e?b:B}})(e,t),o&&h[o]?h[o](e,t,r):r()})(r,o,e)},function(n){var a=o.getElementsByTagName("Children");if(!a||0===a.length)return n(),void 0;for(var d=(a=a[0]).childNodes,l=[],f=0,s=d.length;f<s;f++){var p=d[f];i.shouldIgnoreNode(p)||l.push(p)}if(0===l.length)return n(),void 0;var g=0;e.whilst(function(e){e(null,g<l.length)},function(e){t(null,l[g],c,function(t){r.addChild(t),t.getParent()&&t.setPosition(k(t)),g++,e()})},function(){n()})}],function(){a(d)})})(t,o,"",function(){r()})},function(l){(function(t,a,d,l){var c=i.getFirstChildNodeByName(a,"Animation");if(!c)return l(),void 0;var f=i.getChildNodesByName(c,"Timeline");if(!f||0===f.length)return l(),void 0;var s=function(e){var t=o.dirname(e),r=o.relative(E,t),i=o.basename(e,o.extname(e))+N;return n.join(B,r,i),o.join(I,r,i)}(d);r.existsSync(s)||r.mkdirsSync(s);var p=i.getIntPropertyOfNode(c,"Duration",0),g=i.getFloatPropertyOfNode(c,"Speed",0),u=o.basename(d,o.extname(d)),m=[{name:u,startIndex:0,endIndex:p}],v=0,h=0,P=i.getFirstChildNodeByName(a,"AnimationList");if(P){var C=i.getChildNodesByName(P,"AnimationInfo");if(C&&C.length>0){var S=1;for(v=0,h=C.length;v<h;v++){var b=C[v],F=i.getPropertyOfNode(b,"Name","");if(F){F.toLowerCase()===m[0].name.toLowerCase()&&(m[0].name=u+S,S++);var A=i.getIntPropertyOfNode(b,"StartIndex",0),w=i.getIntPropertyOfNode(b,"EndIndex",p);m.push({name:F,startIndex:A,endIndex:w})}}}}var D={},x=[];for(v=0,h=f.length;v<h;v++){var z=f[v],L=i.getPropertyOfNode(z,"ActionTag",""),_=T[L];if(_){var R=_.nodePath;if(R){var j=i.getPropertyOfNode(z,"Property","");if("FrameEvent"===j)x=V(z,x);else{var H=O[j];if(!H&&""!==j){Editor.warn('Action for property "%s" is not supported.',j);continue}D[R]=H(z,D[R],_.node)}}}}var k=o.dirname(s),U=o.relative(I,k),X=n.join(B,U),W=[];for(v=0,h=m.length;v<h;v++){var Y=m[v],G=Y.name+".anim",q=o.join(s,G),Z=M(Y,D,x);Z.speed=g,Z.sample=y,Z._name=Y.name,Z._duration=(Y.endIndex-Y.startIndex)/y;var J=Editor.serialize(Z);r.writeFileSync(q,J),W.push(n.join(X,o.basename(s),G))}e.waterfall([function(e){Editor.assetdb.import([s],X,!1,function(){e()})},function(e){var r=t.addComponent(cc.Animation);if(r){for(v=0,h=W.length;v<h;v++){var o=W[v],i=Editor.assetdb.remote.urlToUuid(o);if(i){var a=new cc.AnimationClip;a._uuid=i,a._name=n.basenameNoExt(o),r.addClip(a)}}e()}else Editor.warn("Add Animation component failed."),e()}],l)})(t,a,d,l)}],l)}function M(e,t,r){var o=new cc.AnimationClip,n=e.startIndex,i=e.endIndex,a={};for(var d in t)if(t.hasOwnProperty(d)){var l={},c=t[d],f=c.props;if(f){var s={};for(var p in f)f.hasOwnProperty(p)&&(s[p]=R(f[p],n,i));l.props=s}var g=c.comps;if(g){var u=null;for(var m in g)if(g.hasOwnProperty(m)){var N=null,y=g[m];for(var v in y)if(y.hasOwnProperty(v)){var h=R(y[v],n,i);h.length>0&&(N||(N={}),N[v]=h)}N&&(u||(u={}),u[m]=N)}u&&(l.comps=u)}a[d]=l}return o.curveData={paths:a},o.events=R(r,n,i),o}function R(e,t,r){for(var o=[],n=0,i=e.length;n<i;n++){let i=e[n],d=i.frame;if(d<t||d>r)continue;let l={};for(var a in i)i.hasOwnProperty(a)&&("frame"===a?l.frame=(d-t)/y:l[a]=i[a]);o.push(l)}return o}function j(e){return e||(e={}),e.props||(e.props={}),e}function H(e){var t=i.getIntPropertyOfNode(e,"Type",0,"EasingData");if(0===t)return null;var r=null;if(-1===t){var o=i.getFirstChildNodeByName(e,"EasingData"),n=i.getFirstChildNodeByName(o,"Points"),a=i.getChildNodesByName(n,"PointF");r=[i.getFloatPropertyOfNode(a[1],"X","0"),i.getFloatPropertyOfNode(a[1],"Y","0"),i.getFloatPropertyOfNode(a[2],"X","0"),i.getFloatPropertyOfNode(a[2],"Y","0")]}else{var d=Math.floor((t-1)/3),l=(t-1)%3;d<S.length&&(r=S[d]+b[l])}return r}function V(e,t){for(var r=i.getAllChildren(e),o=0,n=r.length;o<n;o++){var a=r[o],d=i.getIntPropertyOfNode(a,"FrameIndex",0),l=i.getPropertyOfNode(a,"Value",""),c={frame:d,func:F};l&&(c.params=[l]),t.push(c)}return t}function k(e,t){t||(t=e.getPosition());var r=e.getParent();if(!r)return t;var o=r.getAnchorPoint(),n=r.getContentSize(),i=t.x-n.width*o.x,a=t.y-n.height*o.y;return cc.v2(i,a)}function U(e,t){var r=t.getAttribute("ctype");if(e.setName(x(t.getAttribute("Name"))),e.setContentSize(i.getFloatPropertyOfNode(t,"X",0,"Size"),i.getFloatPropertyOfNode(t,"Y",0,"Size")),"GameLayerObjectData"===r&&e.setAnchorPoint(0,0),C.indexOf(r)<0){e.active=i.getBoolPropertyOfNode(t,"VisibleForFrame",!0),e.setAnchorPoint(i.getFloatPropertyOfNode(t,"ScaleX",0,"AnchorPoint"),i.getFloatPropertyOfNode(t,"ScaleY",0,"AnchorPoint")),e.setPosition(i.getFloatPropertyOfNode(t,"X",0,"Position"),i.getFloatPropertyOfNode(t,"Y",0,"Position"));var o=i.getFloatPropertyOfNode(t,"ScaleX",1,"Scale"),n=i.getFloatPropertyOfNode(t,"ScaleY",1,"Scale"),a=i.getBoolPropertyOfNode(t,"FlipX",!1),d=i.getBoolPropertyOfNode(t,"FlipY",!1);o=a?-1*o:o,n=d?-1*n:n,e.setScale(o,n);let l=i.getFloatPropertyOfNode(t,"RotationSkewX",0),c=i.getFloatPropertyOfNode(t,"RotationSkewY",0);l===c?e.angle=l:(e.is3DNode=!0,e.eulerAngles=cc.v3(l,c,0)),"TextFieldObjectData"!==r&&"ScrollViewObjectData"!==r&&(e.color=new cc.Color(i.getIntPropertyOfNode(t,"R",255,"CColor"),i.getIntPropertyOfNode(t,"G",255,"CColor"),i.getIntPropertyOfNode(t,"B",255,"CColor")),e.opacity=i.getIntPropertyOfNode(t,"Alpha",255))}}function X(e,t){if(!e&&!t)return null;let r=function(e,t){var r=t;if(e){var o=i.getPropertyOfNode(e,"Type","Default"),a=i.getPropertyOfNode(e,"Path","");switch(o){case"PlistSubImage":var d=i.getPropertyOfNode(e,"Plist","");if(d&&a){var l=n.join(B,d);r=n.join(l,a.replace(v,"-"))}break;case"MarkedSubImage":case"Normal":a&&(r=n.join(B,a),r=n.join(r,n.basenameNoExt(r)))}}let c=Editor.assetdb.remote.urlToUuid(r);return r&&c?c:null}(e,t);if(!r)return Editor.warn("Failed to import spriteframe asset, asset info: "+e+", uuid: "+r),null;if(!Editor.assetdb.remote.existsByUuid(r))return Editor.warn("Failed to import spriteframe asset, asset info: "+e+", url: "+t),null;var o=new cc.SpriteFrame;return o._uuid=r,o}function W(e,t,r){Editor.assetdb.queryMetaInfoByUuid(t,function(o,n){if(!n)return r(),void 0;var d=JSON.parse(n.json),l=i.getIntPropertyOfNode(e,"Scale9OriginX",0),c=i.getIntPropertyOfNode(e,"Scale9OriginY",0),f=i.getIntPropertyOfNode(e,"Scale9Width",d.rawWidth),s=i.getIntPropertyOfNode(e,"Scale9Height",d.rawHeight);d.trimThreshold=-1,d.borderTop=c,d.borderBottom=d.rawHeight-c-s,d.borderBottom<0&&(d.borderBottom=0),d.borderLeft=l,d.borderRight=d.rawWidth-l-f,d.borderRight<0&&(d.borderRight=0);var p=JSON.stringify(d);n.assetUrl.startsWith(a)?r():Editor.assetdb.saveMeta(t,p,function(){r()})})}function Y(e,t,r,o){var n=e.addComponent(cc.Sprite);if(!n)return Editor.warn("Add sprite component for node %s failed.",t.getAttribute("Name")),o;var a=i.getIntPropertyOfNode(t,"Src",cc.macro.BlendFactor.SRC_ALPHA,"BlendFunc");n.srcBlendFactor=1===a?cc.macro.BlendFactor.SRC_ALPHA:a,n.dstBlendFactor=i.getIntPropertyOfNode(t,"Dst",cc.macro.BlendFactor.ONE_MINUS_SRC_ALPHA,"BlendFunc");var d=i.getFirstChildNodeByName(t,"FileData");n.sizeMode=r,n.trim=!1,n.spriteFrame=X(d,""),o()}function G(t,r,o){var n=t.addComponent(cc.Label);if(!n)return Editor.warn("Add Label component for node %s failed.",r.getAttribute("Name")),o(),void 0;switch(i.getBoolPropertyOfNode(r,"IsCustomSize",!1)&&(n.overflow=cc.Label.Overflow.CLAMP,n._useOriginalSize=!1),n.string=i.getPropertyOfNode(r,"LabelText",""),n.lineHeight=0,i.getPropertyOfNode(r,"HorizontalAlignmentType","")){case"HT_Right":n.horizontalAlign=cc.Label.HorizontalAlign.RIGHT;break;case"HT_Center":n.horizontalAlign=cc.Label.HorizontalAlign.CENTER;break;default:n.horizontalAlign=cc.Label.HorizontalAlign.LEFT}switch(i.getPropertyOfNode(r,"VerticalAlignmentType","")){case"VT_Bottom":n.verticalAlign=cc.Label.VerticalAlign.BOTTOM;break;case"VT_Center":n.verticalAlign=cc.Label.VerticalAlign.CENTER;break;default:n.verticalAlign=cc.Label.VerticalAlign.TOP}var a=i.getFirstChildNodeByName(r,"LabelBMFontFile_CNB"),d=i.getFirstChildNodeByName(r,"FontResource");e.waterfall([function(e){a?Z(n,a,e):d?Z(n,d,e):e()},function(e){var t=i.getIntPropertyOfNode(r,"FontSize",-1);t>=0?(n._fontSize=t,e()):a?q(a,(t,r)=>{!t&&r||e();var o=r._fntConfig;n._fontSize=o.fontSize,n.lineHeight=o.commonHeight,e()}):e()}],o)}function q(e,t){var r=n.join(B,i.getPropertyOfNode(e,"Path","")),o=!1;if(r){var a=Editor.assetdb.remote.urlToUuid(r);Editor.assetdb.remote.existsByUuid(a)&&(o=!0)}o?cc.assetManager.loadAny(a,t):t&&t(null,null)}function Z(e,t,r){if(!e||!t)return r&&r(),void 0;q(t,(t,o)=>{t&&Editor.error(t),e.font=o||null,r&&r()})}function J(e,t,r){i.getBoolPropertyOfNode(t,"ClipAble",!1)&&(e.addComponent(cc.Mask).enabled=!0);K(e,t,r)}function K(t,r,o){var n=t.getContentSize().width,a=t.getContentSize().height,l=i.getFirstChildNodeByName(r,"FileData"),c=i.getIntPropertyOfNode(r,"ComboBoxIndex",0),f=null;e.waterfall([function(e){if(l){let n=(f=new cc.Node("background")).addComponent(cc.Sprite);n.trim=!1;var o=X(l,m);if(!o)return e();i.getBoolPropertyOfNode(r,"Scale9Enable",!1)?(f.setContentSize(t.getContentSize()),n.sizeMode=cc.Sprite.SizeMode.CUSTOM,n.type=cc.Sprite.Type.SLICED,n.spriteFrame=o,W(r,o._uuid,e)):(n.spriteFrame=o,e())}else if(1===c){(f=new cc.Node("background")).setContentSize(n,a);let t=f.addComponent(cc.Sprite);t.sizeMode=cc.Sprite.SizeMode.CUSTOM,t.trim=!1,t.spriteFrame=new cc.SpriteFrame,t.spriteFrame._uuid=Editor.assetdb.remote.urlToUuid(d),f.color=new cc.Color(i.getIntPropertyOfNode(r,"R",255,"SingleColor"),i.getIntPropertyOfNode(r,"G",255,"SingleColor"),i.getIntPropertyOfNode(r,"B",255,"SingleColor")),f.opacity=i.getIntPropertyOfNode(r,"BackColorAlpha",255),e()}else e()},function(e){if(f){t.addChild(f);let e=f.addComponent(cc.StudioWidget);e.isAlignHorizontalCenter=!0,e.isAlignVerticalCenter=!0}e()}],o)}function Q(e,t,r){var o=new cc.Node(t),n=o.addComponent(cc.Scrollbar);n.direction=e;var i=o.addComponent(cc.StudioWidget);i.isAlignRight=!0,i.isAlignBottom=!0,i.isAlignTop=e===cc.Scrollbar.Direction.VERTICAL,i.isAlignLeft=e===cc.Scrollbar.Direction.HORIZONTAL;var a=new cc.Node("bar");o.addChild(a);var d=a.addComponent(cc.Sprite);return d.type=cc.Sprite.Type.SLICED,d.trim=!1,d.sizeMode=cc.Sprite.SizeMode.CUSTOM,d.spriteFrame=new cc.SpriteFrame,e===cc.Scrollbar.Direction.HORIZONTAL?(o.setContentSize(r.width,15),a.setContentSize(.7*r.width,15),d.spriteFrame._uuid=Editor.assetdb.remote.urlToUuid(u)):(o.setContentSize(15,r.height),a.setContentSize(15,.7*r.height),d.spriteFrame._uuid=Editor.assetdb.remote.urlToUuid(g)),n.handle=d,o}module.exports={importCSDFiles:function(t,r,o,n,i){E=r,I=o,B=n;var a=0;e.whilst(function(e){e(null,a<t.length)},function(e){w(t[a],function(){a++,e()})},function(){i()})}};