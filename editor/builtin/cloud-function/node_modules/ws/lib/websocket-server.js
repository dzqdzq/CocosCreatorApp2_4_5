"use strict";const e=require("events"),{createHash:t}=require("crypto"),{createServer:s,STATUS_CODES:r}=require("http"),o=require("./permessage-deflate"),n=require("./websocket"),{format:i,parse:c}=require("./extension"),{GUID:l,kWebSocket:a}=require("./constants"),h=/^[+/0-9A-Za-z]{22}==$/;function p(e){e.emit("close")}function d(){this.destroy()}function u(e,t,s,o){e.writable&&(s=s||r[t],o={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(s),...o},e.write(`HTTP/1.1 ${t} ${r[t]}\r\n`+Object.keys(o).map(e=>`${e}: ${o[e]}`).join("\r\n")+"\r\n\r\n"+s)),e.removeListener("error",d),e.destroy()}module.exports=class extends e{constructor(e,t){if(super(),null==(e={maxPayload:104857600,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,...e}).port&&!e.server&&!e.noServer)throw new TypeError('One of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=s((e,t)=>{const s=r[426];t.writeHead(426,{"Content-Length":s.length,"Content-Type":"text/plain"}),t.end(s)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const s of Object.keys(t))e.on(s,t[s]);return function(){for(const s of Object.keys(t))e.removeListener(s,t[s])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,s,r)=>{this.handleUpgrade(t,s,r,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set),this.options=e}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(e&&this.once("close",e),this.clients)for(const e of this.clients)e.terminate();const t=this._server;if(t&&(this._removeListeners(),this._removeListeners=this._server=null,null!=this.options.port))return t.close(()=>this.emit("close")),void 0;process.nextTick(p,this)}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,s,r){t.on("error",d);const n=void 0!==e.headers["sec-websocket-key"]&&e.headers["sec-websocket-key"].trim(),i=+e.headers["sec-websocket-version"],l={};if("GET"!==e.method||"websocket"!==e.headers.upgrade.toLowerCase()||!n||!h.test(n)||8!==i&&13!==i||!this.shouldHandle(e))return u(t,400);if(this.options.perMessageDeflate){const s=new o(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const r=c(e.headers["sec-websocket-extensions"]);r[o.extensionName]&&(s.accept(r[o.extensionName]),l[o.extensionName]=s)}catch(e){return u(t,400)}}if(this.options.verifyClient){const o={origin:e.headers[`${8===i?"sec-websocket-origin":"origin"}`],secure:!(!e.connection.authorized&&!e.connection.encrypted),req:e};if(2===this.options.verifyClient.length)return this.options.verifyClient(o,(o,i,c,a)=>{if(!o)return u(t,i||401,c,a);this.completeUpgrade(n,l,e,t,s,r)}),void 0;if(!this.options.verifyClient(o))return u(t,401)}this.completeUpgrade(n,l,e,t,s,r)}completeUpgrade(e,s,r,c,h,p){if(!c.readable||!c.writable)return c.destroy();if(c[a])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");const u=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${t("sha1").update(e+l).digest("base64")}`],f=new n(null);let m=r.headers["sec-websocket-protocol"];if(m&&(m=m.trim().split(/ *, */),(m=this.options.handleProtocols?this.options.handleProtocols(m,r):m[0])&&(u.push(`Sec-WebSocket-Protocol: ${m}`),f._protocol=m)),s[o.extensionName]){const e=s[o.extensionName].params,t=i({[o.extensionName]:[e]});u.push(`Sec-WebSocket-Extensions: ${t}`),f._extensions=s}this.emit("headers",u,r),c.write(u.concat("\r\n").join("\r\n")),c.removeListener("error",d),f.setSocket(c,h,this.options.maxPayload),this.clients&&(this.clients.add(f),f.on("close",()=>this.clients.delete(f))),p(f,r)}};