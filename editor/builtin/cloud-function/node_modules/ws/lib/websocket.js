"use strict";const e=require("events"),t=require("https"),r=require("http"),s=require("net"),o=require("tls"),{randomBytes:i,createHash:n}=require("crypto"),{URL:a}=require("url"),c=require("./permessage-deflate"),d=require("./receiver"),h=require("./sender"),{BINARY_TYPES:l,EMPTY_BUFFER:u,GUID:p,kStatusCode:_,kWebSocket:f,NOOP:m}=require("./constants"),{addEventListener:S,removeEventListener:y}=require("./event-target"),{format:v,parse:b}=require("./extension"),{toBuffer:N}=require("./buffer-util"),g=["CONNECTING","OPEN","CLOSING","CLOSED"],C=[8,13],k=3e4;class E extends e{constructor(e,s,o){super(),this._binaryType=l[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage="",this._closeTimer=null,this._extensions={},this._protocol="",this._readyState=E.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,Array.isArray(s)?s=s.join(", "):"object"==typeof s&&null!==s&&(o=s,s=void 0),function e(s,o,d,h){const l={protocolVersion:C[1],maxPayload:104857600,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...h,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,host:void 0,path:void 0,port:void 0};if(!C.includes(l.protocolVersion))throw new RangeError(`Unsupported protocol version: ${l.protocolVersion} `+`(supported versions: ${C.join(", ")})`);let u;o instanceof a?(u=o,s._url=o.href):(u=new a(o),s._url=o);const _="ws+unix:"===u.protocol;if(!(u.host||_&&u.pathname))throw new Error(`Invalid URL: ${s.url}`);const f="wss:"===u.protocol||"https:"===u.protocol;const m=f?443:80;const S=i(16).toString("base64");const y=f?t.get:r.get;let N;l.createConnection=f?w:O;l.defaultPort=l.defaultPort||m;l.port=u.port||m;l.host=u.hostname.startsWith("[")?u.hostname.slice(1,-1):u.hostname;l.headers={"Sec-WebSocket-Version":l.protocolVersion,"Sec-WebSocket-Key":S,Connection:"Upgrade",Upgrade:"websocket",...l.headers};l.path=u.pathname+u.search;l.timeout=l.handshakeTimeout;l.perMessageDeflate&&(N=new c(!0!==l.perMessageDeflate?l.perMessageDeflate:{},!1,l.maxPayload),l.headers["Sec-WebSocket-Extensions"]=v({[c.extensionName]:N.offer()}));d&&(l.headers["Sec-WebSocket-Protocol"]=d);l.origin&&(l.protocolVersion<13?l.headers["Sec-WebSocket-Origin"]=l.origin:l.headers.Origin=l.origin);(u.username||u.password)&&(l.auth=`${u.username}:${u.password}`);if(_){const e=l.path.split(":");l.socketPath=e[0],l.path=e[1]}let g=s._req=y(l);l.timeout&&g.on("timeout",()=>{x(s,g,"Opening handshake has timed out")});g.on("error",e=>{null===g||g.aborted||(g=s._req=null,s._readyState=E.CLOSING,s.emit("error",e),s.emitClose())});g.on("response",t=>{const r=t.headers.location,i=t.statusCode;if(r&&l.followRedirects&&i>=300&&i<400){if(++s._redirects>l.maxRedirects)return x(s,g,"Maximum redirects exceeded"),void 0;g.abort();const t=new a(r,o);e(s,t,d,h)}else s.emit("unexpected-response",g,t)||x(s,g,`Unexpected server response: ${t.statusCode}`)});g.on("upgrade",(e,t,r)=>{if(s.emit("upgrade",e),s.readyState!==E.CONNECTING)return;g=s._req=null;const o=n("sha1").update(S+p).digest("base64");if(e.headers["sec-websocket-accept"]!==o)return x(s,t,"Invalid Sec-WebSocket-Accept header"),void 0;const i=e.headers["sec-websocket-protocol"],a=(d||"").split(/, */);let h;if(!d&&i?h="Server sent a subprotocol but none was requested":d&&!i?h="Server sent no subprotocol":i&&!a.includes(i)&&(h="Server sent an invalid subprotocol"),h)return x(s,t,h),void 0;if(i&&(s._protocol=i),N)try{const r=b(e.headers["sec-websocket-extensions"]);r[c.extensionName]&&(N.accept(r[c.extensionName]),s._extensions[c.extensionName]=N)}catch(e){return x(s,t,"Invalid Sec-WebSocket-Extensions header"),void 0}s.setSocket(t,r,l.maxPayload)})}(this,e,s,o)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(e){l.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,r){const s=new d(this.binaryType,this._extensions,this._isServer,r);this._sender=new h(e,this._extensions),this._receiver=s,this._socket=e,s[f]=this,e[f]=this,s.on("conclude",T),s.on("drain",I),s.on("error",G),s.on("message",q),s.on("ping",W),s.on("pong",R),e.setTimeout(0),e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",D),e.on("data",A),e.on("end",M),e.on("error",j),this._readyState=E.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=E.CLOSED,this.emit("close",this._closeCode,this._closeMessage),void 0;this._extensions[c.extensionName]&&this._extensions[c.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=E.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==E.CLOSED){if(this.readyState===E.CONNECTING){const e="WebSocket was closed before the connection was established";return x(this,this._req,e)}if(this.readyState===E.CLOSING)return this._closeFrameSent&&this._closeFrameReceived&&this._socket.end(),void 0;this._readyState=E.CLOSING,this._sender.close(e,t,!this._isServer,e=>{e||(this._closeFrameSent=!0,this._closeFrameReceived&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),k)}}ping(e,t,r){if(this.readyState===E.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState!==E.OPEN)return L(this,e,r),void 0;void 0===t&&(t=!this._isServer),this._sender.ping(e||u,t,r)}pong(e,t,r){if(this.readyState===E.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState!==E.OPEN)return L(this,e,r),void 0;void 0===t&&(t=!this._isServer),this._sender.pong(e||u,t,r)}send(e,t,r){if(this.readyState===E.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(r=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==E.OPEN)return L(this,e,r),void 0;const s={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[c.extensionName]||(s.compress=!1),this._sender.send(e||u,s,r)}terminate(){if(this.readyState!==E.CLOSED){if(this.readyState===E.CONNECTING){const e="WebSocket was closed before the connection was established";return x(this,this._req,e)}this._socket&&(this._readyState=E.CLOSING,this._socket.destroy())}}}function O(e){return e.path=e.socketPath,s.connect(e)}function w(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=s.isIP(e.host)?"":e.host),o.connect(e)}function x(e,t,r){e._readyState=E.CLOSING;const s=new Error(r);Error.captureStackTrace(s,x),t.setHeader?(t.abort(),t.once("abort",e.emitClose.bind(e)),e.emit("error",s)):(t.destroy(s),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function L(e,t,r){if(t){const r=N(t).length;e._socket?e._sender._bufferedBytes+=r:e._bufferedAmount+=r}if(r){r(new Error(`WebSocket is not open: readyState ${e.readyState} `+`(${g[e.readyState]})`))}}function T(e,t){const r=this[f];r._socket.removeListener("data",A),r._socket.resume(),r._closeFrameReceived=!0,r._closeMessage=t,r._closeCode=e,1005===e?r.close():r.close(e,t)}function I(){this[f]._socket.resume()}function G(e){const t=this[f];t._socket.removeListener("data",A),t._readyState=E.CLOSING,t._closeCode=e[_],t.emit("error",e),t._socket.destroy()}function P(){this[f].emitClose()}function q(e){this[f].emit("message",e)}function W(e){const t=this[f];t.pong(e,!t._isServer,m),t.emit("ping",e)}function R(e){this[f].emit("pong",e)}function D(){const e=this[f];this.removeListener("close",D),this.removeListener("end",M),e._readyState=E.CLOSING,e._socket.read(),e._receiver.end(),this.removeListener("data",A),this[f]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",P),e._receiver.on("finish",P))}function A(e){this[f]._receiver.write(e)||this.pause()}function M(){const e=this[f];e._readyState=E.CLOSING,e._receiver.end(),this.end()}function j(){const e=this[f];this.removeListener("error",j),this.on("error",m),e&&(e._readyState=E.CLOSING,this.destroy())}g.forEach((e,t)=>{const r={enumerable:!0,value:t};Object.defineProperty(E.prototype,e,r),Object.defineProperty(E,e,r)}),["binaryType","bufferedAmount","extensions","protocol","readyState","url"].forEach(e=>{Object.defineProperty(E.prototype,e,{enumerable:!0})}),["open","error","close","message"].forEach(e=>{Object.defineProperty(E.prototype,`on${e}`,{configurable:!0,enumerable:!0,get(){const t=this.listeners(e);for(let e=0;e<t.length;e++)if(t[e]._listener)return t[e]._listener},set(t){const r=this.listeners(e);for(let t=0;t<r.length;t++)r[t]._listener&&this.removeListener(e,r[t]);this.addEventListener(e,t)}})}),E.prototype.addEventListener=S,E.prototype.removeEventListener=y,module.exports=E;