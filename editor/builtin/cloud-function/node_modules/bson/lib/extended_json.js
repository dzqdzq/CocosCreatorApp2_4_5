"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EJSON=exports.isBSONType=void 0;const e=require("./binary"),t=require("./code"),n=require("./db_ref"),r=require("./decimal128"),o=require("./double"),i=require("./int_32"),s=require("./long"),u=require("./max_key"),l=require("./min_key"),f=require("./objectid"),a=require("./parser/utils"),c=require("./regexp"),d=require("./symbol"),b=require("./timestamp");function y(e){return a.isObjectLike(e)&&Reflect.has(e,"_bsontype")&&"string"==typeof e._bsontype}exports.isBSONType=y;const p=2147483647,m=-2147483648,g=0x8000000000000000,x=-0x8000000000000000,$={$oid:f.ObjectId,$binary:e.Binary,$uuid:e.Binary,$symbol:d.BSONSymbol,$numberInt:i.Int32,$numberDecimal:r.Decimal128,$numberDouble:o.Double,$numberLong:s.Long,$minKey:l.MinKey,$maxKey:u.MaxKey,$regex:c.BSONRegExp,$regularExpression:c.BSONRegExp,$timestamp:b.Timestamp};function O(e){const t=e.toISOString();return 0!==e.getUTCMilliseconds()?t:t.slice(0,-5)+"Z"}function S(e,r){if(Array.isArray(e))return function(e,t){return e.map(e=>S(e,t))}(e,r);if(void 0===e)return null;if(e instanceof Date){const t=e.getTime(),n=t>-1&&t<2534023188e5;return r.legacy?r.relaxed&&n?{$date:e.getTime()}:{$date:O(e)}:r.relaxed&&n?{$date:O(e)}:{$date:{$numberLong:e.getTime().toString()}}}if("number"==typeof e&&!r.relaxed){if(Math.floor(e)===e){const t=e>=x&&e<=g;if(e>=m&&e<=p)return{$numberInt:e.toString()};if(t)return{$numberLong:e.toString()}}return{$numberDouble:e.toString()}}if(e instanceof RegExp){let t=e.flags;if(void 0===t){const n=e.toString().match(/[gimuy]*$/);n&&(t=n[0])}return new c.BSONRegExp(e.source,t).toExtendedJSON(r)}return null!=e&&"object"==typeof e?function(e,r){if(null==e||"object"!=typeof e)throw new Error("not an object instance");const o=e._bsontype;if(void 0===o){const t={};for(const n in e)t[n]=S(e[n],r);return t}if(y(e)){let i=e;if("function"!=typeof i.toExtendedJSON){const t=w[e._bsontype];if(!t)throw new TypeError("Unrecognized or invalid _bsontype: "+e._bsontype);i=t(i)}return"Code"===o&&i.scope?i=new t.Code(i.code,S(i.scope,r)):"DBRef"===o&&i.oid&&(i=new n.DBRef(i.collection,S(i.oid,r),i.db,i.fields)),i.toExtendedJSON(r)}throw new Error("_bsontype must be a string, but was: "+typeof o)}(e,r):e}const w={Binary:t=>new e.Binary(t.value(),t.sub_type),Code:e=>new t.Code(e.code,e.scope),DBRef:e=>new n.DBRef(e.collection||e.namespace,e.oid,e.db,e.fields),Decimal128:e=>new r.Decimal128(e.bytes),Double:e=>new o.Double(e.value),Int32:e=>new i.Int32(e.value),Long:e=>s.Long.fromBits(null!=e.low?e.low:e.low_,null!=e.low?e.high:e.high_,null!=e.low?e.unsigned:e.unsigned_),MaxKey:()=>new u.MaxKey,MinKey:()=>new l.MinKey,ObjectID:e=>new f.ObjectId(e),ObjectId:e=>new f.ObjectId(e),BSONRegExp:e=>new c.BSONRegExp(e.pattern,e.options),Symbol:e=>new d.BSONSymbol(e.value),Timestamp:e=>b.Timestamp.fromBits(e.low,e.high)};(function(e){function r(e,r){const u=Object.assign({},{relaxed:!0,legacy:!1},r);return"boolean"==typeof u.relaxed&&(u.strict=!u.relaxed),"boolean"==typeof u.strict&&(u.relaxed=!u.strict),JSON.parse(e,(e,r)=>(function e(r,u={}){if("number"==typeof r){if(u.relaxed||u.legacy)return r;if(Math.floor(r)===r){if(r>=m&&r<=p)return new i.Int32(r);if(r>=x&&r<=g)return s.Long.fromNumber(r)}return new o.Double(r)}if(null==r||"object"!=typeof r)return r;if(r.$undefined)return null;const l=Object.keys(r).filter(e=>e.startsWith("$")&&null!=r[e]);for(let e=0;e<l.length;e++){const t=$[l[e]];if(t)return t.fromExtendedJSON(r,u)}if(null!=r.$date){const e=r.$date,t=new Date;return u.legacy?"number"==typeof e?t.setTime(e):"string"==typeof e&&t.setTime(Date.parse(e)):"string"==typeof e?t.setTime(Date.parse(e)):s.Long.isLong(e)?t.setTime(e.toNumber()):"number"==typeof e&&u.relaxed&&t.setTime(e),t}if(null!=r.$code){const n=Object.assign({},r);return r.$scope&&(n.$scope=e(r.$scope)),t.Code.fromExtendedJSON(r)}if(null!=r.$ref||null!=r.$dbPointer){const e=r.$ref?r:r.$dbPointer;if(e instanceof n.DBRef)return e;let t=!0;if(Object.keys(e).filter(e=>e.startsWith("$")).forEach(e=>{-1===["$ref","$id","$db"].indexOf(e)&&(t=!1)}),t)return n.DBRef.fromExtendedJSON(e)}return r})(r,u))}function u(e,t,n,r){null!=n&&"object"==typeof n&&(r=n,n=0),null==t||"object"!=typeof t||Array.isArray(t)||(r=t,t=void 0,n=0);const o=S(e,r=Object.assign({},{relaxed:!0,legacy:!1},r));return JSON.stringify(o,t,n)}e.parse=r,e.stringify=u,e.serialize=function(e,t){return t=t||{},JSON.parse(u(e,t))},e.deserialize=function(e,t){return t=t||{},r(JSON.stringify(e),t)}})(exports.EJSON||(exports.EJSON={}));