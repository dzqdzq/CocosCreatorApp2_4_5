"use strict";var e=this&&this.__decorate||function(e,t,o,r){var i,a=arguments.length,l=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(l=(a<3?i(l):a>3?i(t,o,l):i(t,o))||l);return a>3&&l&&Object.defineProperty(t,o,l),l},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.StorageService=void 0;const o=t(require("fs")),r=t(require("util")),i=t(require("path")),a=t(require("make-dir")),l=t(require("walkdir")),s=t(require("micromatch")),n=t(require("cos-nodejs-sdk-v5")),u=require("../utils"),c=require("../error"),d=require("../utils/parallel"),g=5242880;class y{constructor(e){this.environment=e,this.tcbService=new u.CloudService(e.cloudBaseContext,"tcb","2018-06-08")}async uploadFile(e){const{localPath:t,cloudPath:o="",onProgress:r}=e,{bucket:i,region:a}=this.getStorageConfig();return this.uploadFileCustom({localPath:t,cloudPath:o,bucket:i,region:a,onProgress:r})}async uploadFiles(e){const{files:t,onProgress:o,parallel:r,onFileFinish:i,ignore:a}=e,{bucket:l,region:s}=this.getStorageConfig();return this.uploadFilesCustom({files:t,bucket:l,region:s,ignore:a,parallel:r,onProgress:o,onFileFinish:i})}async uploadFileCustom(e){const{localPath:t,cloudPath:a,bucket:l,region:s,onProgress:n,fileId:d=!0}=e;let y="",p=i.default.resolve(t);u.checkFullAccess(p,!0);const f=o.default.statSync(p);if(f.isDirectory()){const e=i.default.parse(a).base,o=i.default.join(t,e);u.checkFullAccess(o)&&(y=i.default.resolve(o))}else y=p;if(!y)throw new c.CloudBaseError("本地文件不存在！");const h=this.getCos(),C=r.default.promisify(h.putObject).bind(h),m=r.default.promisify(h.sliceUploadFile).bind(h);let k,w;if(d){k=(await this.getUploadMetadata(a)).cosFileId}if(200!==(w=f.size<g?await C({onProgress:n,Bucket:l,Region:s,Key:a,StorageClass:"STANDARD",ContentLength:f.size,Body:o.default.createReadStream(y),"x-cos-meta-fileid":k}):await m({Bucket:l,Region:s,Key:a,FilePath:y,StorageClass:"STANDARD",AsyncLimit:3,onProgress:n,"x-cos-meta-fileid":k})).statusCode)throw new c.CloudBaseError(`上传文件错误：${JSON.stringify(w)}`);return w}async uploadDirectory(e){const{localPath:t,cloudPath:o="",ignore:r,onProgress:i,onFileFinish:a}=e,{bucket:l,region:s}=this.getStorageConfig();return this.uploadDirectoryCustom({localPath:t,cloudPath:o,bucket:l,region:s,ignore:r,onProgress:i,onFileFinish:a})}async uploadDirectoryCustom(e){const{localPath:t,cloudPath:o,bucket:a,region:l,onProgress:s,onFileFinish:n,ignore:c,fileId:y=!0,parallel:p=20}=e,f=i.default.resolve(t),h=i.default.join(f,i.default.sep),C=await this.walkLocalDir(h,c);if(!C||!C.length)return;const m=C.map(e=>{const t=e.replace(h,"").replace(/\\/g,"/");let r=i.default.join(o,t).replace(/\\/g,"/");return u.isDirectory(e)?{filePath:e,cloudFileKey:r=this.getCloudKey(r),isDir:!0}:{filePath:e,cloudFileKey:r,isDir:!1}}),k=new d.AsyncTaskParallelController(p,50),w=m.filter(e=>e.isDir).map(e=>()=>this.createCloudDirectroyCustom({cloudPath:e.cloudFileKey,bucket:a,region:l}));k.loadTasks(w),await k.run();const P=m.filter(e=>!e.isDir).map(e=>async()=>{let t;if(y){t=(await this.getUploadMetadata(e.cloudFileKey)).cosFileId}return{Bucket:a,Region:l,Key:e.cloudFileKey,FilePath:e.filePath,"x-cos-meta-fileid":t}}),b=new d.AsyncTaskParallelController(p,50);b.loadTasks(P);const F=await b.run(),D=this.getCos(p);return r.default.promisify(D.uploadFiles).bind(D)({files:F,SliceSize:g,onProgress:s,onFileFinish:n})}async uploadFilesCustom(e){const{files:t,bucket:o,region:i,ignore:a,onProgress:l,onFileFinish:n,fileId:u=!0,parallel:c=20}=e;if(!t||!t.length)return;let y=t.map(e=>{const{localPath:t,cloudPath:o}=e;return{filePath:t,cloudFileKey:o}}).filter(e=>null===a||void 0===a||!a.length||!s.default.isMatch(e.filePath,a));const p=y.map(e=>async()=>{let t;if(u){t=(await this.getUploadMetadata(e.cloudFileKey)).cosFileId}return{Bucket:o,Region:i,Key:e.cloudFileKey,FilePath:e.filePath,"x-cos-meta-fileid":t}}),f=new d.AsyncTaskParallelController(c,50);f.loadTasks(p),y=await f.run();const h=this.getCos(c);return r.default.promisify(h.uploadFiles).bind(h)({onProgress:l,onFileFinish:n,files:y,SliceSize:g})}async createCloudDirectroy(e){const{bucket:t,region:o}=this.getStorageConfig();await this.createCloudDirectroyCustom({cloudPath:e,bucket:t,region:o})}async createCloudDirectroyCustom(e){const{cloudPath:t,bucket:o,region:i}=e,a=this.getCos(),l=r.default.promisify(a.putObject).bind(a),s=this.getCloudKey(t),n=await l({Bucket:o,Region:i,Key:s,Body:""});if(200!==n.statusCode)throw new c.CloudBaseError(`创建文件夹失败：${JSON.stringify(n)}`)}async downloadFile(e){const{cloudPath:t,localPath:r}=e,a=i.default.resolve(r),l=i.default.dirname(r);u.checkFullAccess(l,!0);const s=await this.getTemporaryUrl([t]),{url:n}=s[0],{proxy:c}=await this.environment.getAuthConfig(),d=await u.fetchStream(n,{},c);if(!r)return d.body;const g=o.default.createWriteStream(a);return d.body.pipe(g),new Promise(e=>{g.on("close",()=>{e(a)})})}async downloadDirectory(e){const{cloudPath:t,localPath:o}=e,r=i.default.resolve(o);u.checkFullAccess(r,!0);const l=this.getCloudKey(t),s=(await this.walkCloudDir(l)).map(async e=>{const t=e.Key.replace(l,"");if(!t||/\/$/g.test(t))return;const o=i.default.join(r,t),s=i.default.dirname(o);return await a.default(s),this.downloadFile({cloudPath:e.Key,localPath:o})});return Promise.all(s)}async listDirectoryFiles(e){return this.walkCloudDir(e)}async getTemporaryUrl(e){if(!e||!Array.isArray(e))throw new c.CloudBaseError("fileList 必须是非空的数组");const t=e.map(e=>"string"==typeof e?{cloudPath:e,maxAge:3600}:e),o=t.find(e=>!e.cloudPath||!e.maxAge||"string"!=typeof e.cloudPath);if(o)throw new c.CloudBaseError(`非法参数：${JSON.stringify(o)}`);const r=[],i=t.map(e=>(async()=>{try{await this.getFileInfo(e.cloudPath)}catch(t){404===t.statusCode&&r.push(e.cloudPath)}})());if(await Promise.all(i),r.length)throw new c.CloudBaseError(`以下文件不存在：${r.join(", ")}`);const a=t.map(e=>({fileid:this.cloudPathToFileId(e.cloudPath),max_age:e.maxAge})),l=this.environment.getAuthConfig();return(await u.cloudBaseRequest({config:l,params:{file_list:a,action:"storage.batchGetDownloadUrl"},method:"POST"})).data.download_list.map(e=>({url:e.download_url,fileId:e.fileid||e.fileID}))}async deleteFile(e){if(!e||!Array.isArray(e))throw new c.CloudBaseError("fileList必须是非空的数组");if(e.some(e=>!e||"string"!=typeof e))throw new c.CloudBaseError("fileList的元素必须是非空的字符串");const{bucket:t,env:o}=this.getStorageConfig(),r=e.map(e=>this.cloudPathToFileId(e)),i=this.environment.getAuthConfig(),a=(await u.cloudBaseRequest({config:i,params:{action:"storage.batchDeleteFile",fileid_list:r},method:"POST"})).data.delete_list.filter(e=>"SUCCESS"!==e.code).map(e=>`${e.fileID} : ${e.code}`);if(a.length)throw new c.CloudBaseError(`部分删除文件失败：${JSON.stringify(a)}`)}async deleteFileCustom(e,t,o){if(!e||!Array.isArray(e))throw new c.CloudBaseError("fileList必须是非空的数组");if(e.some(e=>!e||"string"!=typeof e))throw new c.CloudBaseError("fileList的元素必须是非空的字符串");const i=this.getCos(),a=r.default.promisify(i.deleteObject).bind(i),l=e.map(async e=>a({Bucket:t,Region:o,Key:e}));await Promise.all(l)}async getFileInfo(e){const t=this.getCos(),o=r.default.promisify(t.headObject).bind(t),{bucket:i,region:a}=this.getStorageConfig(),{headers:l}=await o({Bucket:i,Region:a,Key:e});if(!l)throw new c.CloudBaseError(`[${e}] 获取文件信息失败`);return{Size:Number(Number(l["content-length"])/1024).toFixed(2),Type:l["content-type"],Date:l.date,ETag:l.etag}}async deleteDirectory(e){const{bucket:t,region:o}=this.getStorageConfig();return this.deleteDirectoryCustom({cloudPath:e,bucket:t,region:o})}async deleteDirectoryCustom(e){const{cloudPath:t,bucket:o,region:i}=e,a=this.getCloudKey(t),l=this.getCos(),s=r.default.promisify(l.deleteMultipleObject).bind(l),n=await this.walkCloudDirCustom({bucket:o,region:i,prefix:a});if(!n.length)return{Deleted:[],Error:[]};const u=[],c=Math.ceil(n.length/500);for(let e=0;e<c;e++)u.push(n.splice(0,500));const d=u.map(e=>s({Bucket:o,Region:i,Objects:e.map(e=>({Key:e.Key}))})),g=await Promise.all(d);return{Deleted:g.map(e=>e.Deleted).reduce((e,t)=>[...e,...t],[]),Error:g.map(e=>e.Error).reduce((e,t)=>[...e,...t],[])}}async getStorageAcl(){const{bucket:e,env:t}=this.getStorageConfig();return(await this.tcbService.request("DescribeStorageACL",{EnvId:t,Bucket:e})).AclTag}async setStorageAcl(e){if(!["READONLY","PRIVATE","ADMINWRITE","ADMINONLY"].includes(e))throw new c.CloudBaseError("非法的权限类型");const{bucket:t,env:o}=this.getStorageConfig();return this.tcbService.request("ModifyStorageACL",{EnvId:o,Bucket:t,AclTag:e})}async walkCloudDir(e,t){const{bucket:o,region:r}=this.getStorageConfig();return this.walkCloudDirCustom({prefix:e,bucket:o,region:r,marker:t})}async walkCloudDirCustom(e){const{prefix:t,bucket:o,region:i,marker:a="/"}=e;let l=[];const s=this.getCos(),n=r.default.promisify(s.getBucket).bind(s),u=this.getCloudKey(t),c=await n({Bucket:o,Region:i,Prefix:u,MaxKeys:100,Marker:a});l.push(...c.Contents);let d=[];return"true"!==c.IsTruncated&&!0!==c.IsTruncated||(d=await this.walkCloudDirCustom({bucket:o,region:i,prefix:u,marker:c.NextMarker})),l.push(...d),l}async walkLocalDir(e,t){try{return l.default.async(e,{filter:(o,r)=>t&&t.length?r.filter(r=>{const a=i.default.join(o,r).replace(i.default.join(e,i.default.sep),"");return!s.default.isMatch(a,t)}):r})}catch(e){throw new c.CloudBaseError(e.message)}}async getUploadMetadata(e){const t=this.environment.getAuthConfig(),o=await u.cloudBaseRequest({config:t,params:{path:e,action:"storage.getUploadMetadata"},method:"POST"});if(o.code)throw new c.CloudBaseError(`${o.code}: ${o.message||""}`,{requestId:o.requestId});return o.data}async getWebsiteConfig(e){const{bucket:t,region:o}=e,i=this.getCos(),a=r.default.promisify(i.getBucketWebsite).bind(i);return await a({Bucket:t,Region:o})}async putBucketWebsite(e){const{indexDocument:t,errorDocument:o,bucket:i,region:a,routingRules:l}=e,s=this.getCos(),n=r.default.promisify(s.putBucketWebsite).bind(s);let u={Bucket:i,Region:a,WebsiteConfiguration:{IndexDocument:{Suffix:t},ErrorDocument:{Key:o}}};if(l){u.WebsiteConfiguration.RoutingRules=[];for(let e of l){const t={};e.keyPrefixEquals&&(t.Condition={KeyPrefixEquals:e.keyPrefixEquals}),e.httpErrorCodeReturnedEquals&&(t.Condition={HttpErrorCodeReturnedEquals:e.httpErrorCodeReturnedEquals}),e.replaceKeyWith&&(t.Redirect={ReplaceKeyWith:e.replaceKeyWith}),e.replaceKeyPrefixWith&&(t.Redirect={ReplaceKeyPrefixWith:e.replaceKeyPrefixWith}),u.WebsiteConfiguration.RoutingRules.push(t)}}return console.log("params:",JSON.stringify(u)),await n(u)}async getBucket(e){const{prefix:t,maxKeys:o,marker:i,bucket:a,region:l}=e,s=this.getCos(),n=r.default.promisify(s.getBucket).bind(s),u=this.getCloudKey(t);return await n({Bucket:a,Region:l,Prefix:u,MaxKeys:o,Marker:i})}getCos(e=20){const{secretId:t,secretKey:o,token:r,proxy:i}=this.environment.getAuthConfig(),a=process.env.TCB_COS_PROXY;return new n.default({FileParallelLimit:e,SecretId:t,SecretKey:o,Proxy:a||i,SecurityToken:r})}getCloudKey(e){return e?"/"===e?"":"/"===e[e.length-1]?e:`${e}/`:""}cloudPathToFileId(e){const{env:t,bucket:o}=this.getStorageConfig();return`cloud://${t}.${o}/${e}`}getStorageConfig(){var e;const t=this.environment.lazyEnvironmentConfig,o=null===(e=null===t||void 0===t?void 0:t.Storages)||void 0===e?void 0:e[0],{Region:r,Bucket:i}=o;return{region:process.env.TCB_COS_REGION||r,bucket:i,env:t.EnvId}}}e([u.preLazy()],y.prototype,"uploadFile",null),e([u.preLazy()],y.prototype,"uploadFiles",null),e([u.preLazy()],y.prototype,"uploadFileCustom",null),e([u.preLazy()],y.prototype,"uploadDirectory",null),e([u.preLazy()],y.prototype,"uploadDirectoryCustom",null),e([u.preLazy()],y.prototype,"uploadFilesCustom",null),e([u.preLazy()],y.prototype,"createCloudDirectroy",null),e([u.preLazy()],y.prototype,"createCloudDirectroyCustom",null),e([u.preLazy()],y.prototype,"downloadFile",null),e([u.preLazy()],y.prototype,"downloadDirectory",null),e([u.preLazy()],y.prototype,"listDirectoryFiles",null),e([u.preLazy()],y.prototype,"getTemporaryUrl",null),e([u.preLazy()],y.prototype,"deleteFile",null),e([u.preLazy()],y.prototype,"deleteFileCustom",null),e([u.preLazy()],y.prototype,"getFileInfo",null),e([u.preLazy()],y.prototype,"deleteDirectory",null),e([u.preLazy()],y.prototype,"deleteDirectoryCustom",null),e([u.preLazy()],y.prototype,"getStorageAcl",null),e([u.preLazy()],y.prototype,"setStorageAcl",null),e([u.preLazy()],y.prototype,"walkCloudDir",null),e([u.preLazy()],y.prototype,"walkCloudDirCustom",null),e([u.preLazy()],y.prototype,"putBucketWebsite",null),e([u.preLazy()],y.prototype,"getBucket",null),exports.StorageService=y;