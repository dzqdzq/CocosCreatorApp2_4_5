"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CloudService=void 0;const t=e(require("crypto")),s=require("url"),r=e(require("query-string")),n=require("../error"),o=require("./http-request"),i=require("../constant"),c=require("../utils");function a(e){if(Array.isArray(e))return e.map(a);if(function(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}(e)){let t={};for(let s in e)if(Object.prototype.hasOwnProperty.call(e,s)){const r=e[s];void 0!==r&&null!==r&&(t[s]=a(r))}return t}return e}function u(e,s,r){return t.default.createHmac("sha256",s).update(e).digest(r)}function h(e){return t.default.createHash("sha256").update(e).digest("hex")}exports.CloudService=class{constructor(e,t,s,r){this.service=t,this.version=s,this.timeout=6e4,this.baseParams=r||{},this.cloudBaseContext=e}get baseUrl(){const e={tcb:process.env.TCB_BASE_URL||"https://tcb.tencentcloudapi.com",scf:"https://scf.tencentcloudapi.com",vpc:"https://vpc.tencentcloudapi.com",flexdb:"https://flexdb.tencentcloudapi.com",cam:"https://cam.tencentcloudapi.com",cdn:"https://cdn.tencentcloudapi.com"};return e[this.service]?e[this.service]:`https://${this.service}.tencentcloudapi.com`}async request(e,t={},s="POST"){this.action=e,this.data=a(Object.assign(Object.assign({},t),this.baseParams)),this.method=s,this.url=this.baseUrl;let{secretId:r,secretKey:o,token:u}=this.cloudBaseContext;if(!r||!o){const e=c.getEnvVar(i.ENV_NAME.ENV_SECRETID),t=c.getEnvVar(i.ENV_NAME.ENV_SECRETKEY),s=c.getEnvVar(i.ENV_NAME.ENV_SESSIONTOKEN);if(!e||!t)throw c.getRuntime()===i.RUN_ENV.SCF?new Error("missing authoration key, redeploy the function"):new Error("missing secretId or secretKey of tencent cloud");r=e,o=t,u=s}this.secretId=r,this.secretKey=o,this.token=u;try{const t=await this.requestWithSign();if(t.Response.Error)throw new n.CloudBaseError(t.Response.Error.Message,{action:e,requestId:t.Response.RequestId,code:t.Response.Error.Code,original:t.Response.Error});return t.Response}catch(t){throw"CloudBaseError"===t.name?t:new n.CloudBaseError(t.message,{action:e,code:t.code})}}async requestWithSign(){const e=Math.floor((new Date).getTime()/1e3),{proxy:t}=this.cloudBaseContext,{method:n,timeout:i,data:c={}}=this;"GET"===n&&(this.url+="?"+r.default.stringify(c)),"POST"===n&&(this.payload=c);const a={method:n,timeout:i,headers:{Host:new s.URL(this.url).host,"X-TC-Action":this.action,"X-TC-Region":process.env.TCB_REGION||this.cloudBaseContext.region||process.env.TENCENTCLOUD_REGION||"ap-shanghai","X-TC-Timestamp":e,"X-TC-Version":this.version}};this.token&&(a.headers["X-TC-Token"]=this.token),"GET"===n&&(a.headers["Content-Type"]="application/x-www-form-urlencoded"),"POST"===n&&(a.body=JSON.stringify(c),a.headers["Content-Type"]="application/json");const u=this.getRequestSign(e);return a.headers.Authorization=u,o.fetch(this.url,a,t)}getRequestSign(e){const{method:t="POST",url:r,service:n,secretId:o,secretKey:i}=this,c=new s.URL(r);let a="";"GET"===t?a="content-type:application/x-www-form-urlencoded\n":"POST"===t&&(a="content-type:application/json\n"),a+=`host:${c.hostname}\n`;const d=`${t}\n${c.pathname}\n${c.search.slice(1)}\n${a}\ncontent-type;host\n${this.payload?h(JSON.stringify(this.payload)):h("")}`,l=function(e){const t=new Date(1e3*e);return`${t.getUTCFullYear()}-${("0"+(t.getUTCMonth()+1)).slice(-2)}-${("0"+t.getUTCDate()).slice(-2)}`}(e);return`TC3-HMAC-SHA256 Credential=${o}/${l}/${n}/tc3_request, SignedHeaders=content-type;host, Signature=${u(`TC3-HMAC-SHA256\n${e}\n${l}/${n}/tc3_request\n${h(d)}`,u("tc3_request",u(n,u(l,`TC3${i}`))),"hex")}`}};