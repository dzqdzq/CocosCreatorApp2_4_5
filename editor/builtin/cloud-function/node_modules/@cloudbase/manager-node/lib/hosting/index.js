"use strict";var e=this&&this.__decorate||function(e,t,o,i){var n,r=arguments.length,a=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,i);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(r<3?n(a):r>3?n(t,o,a):n(t,o))||a);return r>3&&a&&Object.defineProperty(t,o,a),a},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HostingService=void 0;const o=t(require("fs")),i=t(require("path")),n=t(require("make-dir")),r=require("../error"),a=require("../utils"),s=require("../utils/parallel"),c=new Map,l={init:"初始化中",process:"处理中",online:"上线",destroying:"销毁中",offline:"下线",create_fail:"初始化失败",destroy_fail:"销毁失败"};class u{constructor(e){this.environment=e,this.tcbService=new a.CloudService(e.cloudBaseContext,"tcb","2018-06-08"),this.cdnService=new a.CloudService(e.cloudBaseContext,"cdn","2018-06-06")}async getInfo(){const{envId:e}=this.getHostingConfig(),{Data:t}=await this.tcbService.request("DescribeStaticStore",{EnvId:e});return t}async enableService(){const{envId:e}=this.getHostingConfig(),t=await this.getInfo();if(null===t||void 0===t?void 0:t.length){if("offline"!==t[0].Status)throw new r.CloudBaseError("静态网站服务已开启，请勿重复操作！")}const o=await this.tcbService.request("CreateStaticStore",{EnvId:e});return{code:"succ"===o.Result?0:-1,requestId:o.RequestId}}async findFiles(e){const t=await this.checkStatus(),{Bucket:o,Regoin:i}=t,{maxKeys:n,marker:r,prefix:a}=e,s=await this.environment.getStorageService();return await s.getBucket({bucket:o,region:i,maxKeys:n,marker:r,prefix:a})}async listFiles(){const e=await this.checkStatus(),{Bucket:t,Regoin:o}=e,i=await this.environment.getStorageService();return await i.walkCloudDirCustom({prefix:"",bucket:t,region:o})}async destroyService(){const{envId:e}=this.getHostingConfig(),t=await this.listFiles();if(null===t||void 0===t?void 0:t.length)throw new r.CloudBaseError("静态网站文件不为空，无法销毁！",{code:"INVALID_OPERATION"});const o=await this.getInfo();if(!o||!o.length)throw new r.CloudBaseError("静态网站服务未开启！",{code:"INVALID_OPERATION"});const i=o[0];if("online"!==i.Status&&"destroy_fail"!==i.Status)throw new r.CloudBaseError(`静态网站服务【${l[i.Status]}】，无法进行此操作！`,{code:"INVALID_OPERATION"});const n=await this.tcbService.request("DestroyStaticStore",{EnvId:e});return{code:"succ"===n.Result?0:-1,requestId:n.RequestId}}async uploadFiles(e){const{localPath:t,cloudPath:o,files:n=[],onProgress:r,onFileFinish:s,parallel:c=20,ignore:l}=e,u=await this.checkStatus(),{Bucket:d,Regoin:g}=u,h=await this.environment.getStorageService();let y=Array.isArray(n)?n:[];if(t){const e=i.default.resolve(t);if(a.checkReadable(e,!0),a.isDirectory(e))return h.uploadDirectoryCustom({localPath:e,cloudPath:o,bucket:d,region:g,onProgress:r,onFileFinish:s,fileId:!1,ignore:l});{const t=o||i.default.parse(e).base;y.push({localPath:e,cloudPath:t})}}return h.uploadFilesCustom({ignore:l,parallel:c,onProgress:r,onFileFinish:s,bucket:d,region:g,files:y,fileId:!1})}async deleteFiles(e){const{cloudPath:t,isDir:o}=e,i=await this.checkStatus(),{Bucket:n,Regoin:r}=i,a=await this.environment.getStorageService();if(o)return a.deleteDirectoryCustom({cloudPath:t,bucket:n,region:r});try{return await a.deleteFileCustom([t],n,r),{Deleted:[{Key:t}],Error:[]}}catch(e){return{Deleted:[],Error:[e]}}}async downloadFile(e){const{cloudPath:t,localPath:n}=e,r=i.default.resolve(n),s=i.default.dirname(n);a.checkFullAccess(s,!0);const l=this.environment.lazyEnvironmentConfig,u=c.get(l.EnvId);let d;if((null===u||void 0===u?void 0:u.cacheTime)&&Number(null===u||void 0===u?void 0:u.cacheTime)+12e4<Date.now())console.log("cache"),d=u.CdnDomain;else{const e=await this.checkStatus();d=e.CdnDomain,c.set(l.EnvId,Object.assign(Object.assign({},e),{cacheTime:Date.now()}))}const g=new URL(t,`https://${d}`).toString(),{proxy:h}=await this.environment.getAuthConfig(),y=await a.fetchStream(g,{},h);if(!n)return y.body;const p=o.default.createWriteStream(r);return y.body.pipe(p),new Promise(e=>{p.on("close",()=>{e(r)})})}async downloadDirectory(e){const{cloudPath:t,localPath:o}=e,r=i.default.resolve(o),a=await this.checkStatus(),{Bucket:c,Regoin:l}=a,u=this.getCloudKey(t),d=await this.environment.getStorageService(),g=(await d.walkCloudDirCustom({prefix:u,bucket:c,region:l})).map(e=>async()=>{const t=e.Key.replace(u,"");if(!t||/\/$/g.test(t))return;const o=i.default.join(r,t),a=i.default.dirname(o);return await n.default(a),this.downloadFile({cloudPath:e.Key,localPath:o})}),h=new s.AsyncTaskParallelController(20,50);h.loadTasks(g),await h.run()}async walkLocalDir(e,t){return(await this.environment.getStorageService()).walkLocalDir(t)}async CreateHostingDomain(e){const{envId:t}=this.getHostingConfig(),{certId:o,domain:i}=e;return await this.tcbService.request("CreateHostingDomain",{EnvId:t,Domain:i,CertId:o})}async deleteHostingDomain(e){const{envId:t}=this.getHostingConfig(),{domain:o}=e;return this.tcbService.request("DeleteHostingDomain",{EnvId:t,Domain:o})}async tcbCheckResource(e){return this.cdnService.request("TcbCheckResource",{Domains:e.domains})}async tcbModifyAttribute(e){const{domain:t,domainId:o,domainConfig:i}=e;return await this.cdnService.request("TcbModifyAttribute",{Domain:t,DomainId:o,DomainConfig:i})}async getWebsiteConfig(){const e=await this.checkStatus(),{Bucket:t,Regoin:o}=e,i=await this.environment.getStorageService();return await i.getWebsiteConfig({bucket:t,region:o})}async setWebsiteDocument(e){const{indexDocument:t,errorDocument:o,routingRules:i}=e,n=await this.checkStatus(),{Bucket:r,Regoin:a}=n,s=await this.environment.getStorageService();return await s.putBucketWebsite({bucket:r,region:a,indexDocument:t,errorDocument:o,routingRules:i})}async checkStatus(){const e=await this.getInfo();if(!e||!e.length)throw new r.CloudBaseError("您还没有开启静态网站服务，请先到云开发控制台开启静态网站服务！",{code:"INVALID_OPERATION"});const t=e[0];if("online"!==t.Status)throw new r.CloudBaseError(`静态网站服务【${l[t.Status]}】，无法进行此操作！`,{code:"INVALID_OPERATION"});return t}getHostingConfig(){var e;const t=this.environment.lazyEnvironmentConfig,o=null===(e=t.Storages[0])||void 0===e?void 0:e.AppId,{proxy:i}=this.environment.cloudBaseContext;return{appId:o,proxy:i,envId:t.EnvId}}getCloudKey(e){return e?"/"===e?"":"/"===e[e.length-1]?e:`${e}/`:""}}e([a.preLazy()],u.prototype,"getInfo",null),e([a.preLazy()],u.prototype,"enableService",null),e([a.preLazy()],u.prototype,"listFiles",null),e([a.preLazy()],u.prototype,"destroyService",null),e([a.preLazy()],u.prototype,"uploadFiles",null),e([a.preLazy()],u.prototype,"deleteFiles",null),e([a.preLazy()],u.prototype,"downloadFile",null),e([a.preLazy()],u.prototype,"downloadDirectory",null),e([a.preLazy()],u.prototype,"walkLocalDir",null),e([a.preLazy()],u.prototype,"CreateHostingDomain",null),e([a.preLazy()],u.prototype,"deleteHostingDomain",null),e([a.preLazy()],u.prototype,"checkStatus",null),exports.HostingService=u;