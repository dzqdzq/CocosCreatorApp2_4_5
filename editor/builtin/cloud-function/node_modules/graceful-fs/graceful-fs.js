var e,t,n=require("fs"),r=require("./polyfills.js"),o=require("./legacy-streams.js"),i=require("./clone.js"),u=require("util");function c(t,n){Object.defineProperty(t,e,{get:function(){return n}})}"function"==typeof Symbol&&"function"==typeof Symbol.for?(e=Symbol.for("graceful-fs.queue"),t=Symbol.for("graceful-fs.previous")):(e="___graceful-fs.queue",t="___graceful-fs.previous");var f=function(){};if(u.debuglog?f=u.debuglog("gfs4"):/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&(f=function(){var e=u.format.apply(u,arguments);e="GFS4: "+e.split(/\n/).join("\nGFS4: "),console.error(e)}),!n[e]){var a=global[e]||[];c(n,a),n.close=function(e){function r(t,r){return e.call(n,t,function(e){e||s(),"function"==typeof r&&r.apply(this,arguments)})}return Object.defineProperty(r,t,{value:e}),r}(n.close),n.closeSync=function(e){function r(t){e.apply(n,arguments),s()}return Object.defineProperty(r,t,{value:e}),r}(n.closeSync),/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&process.on("exit",function(){f(n[e]),require("assert").equal(n[e].length,0)})}function p(e){r(e),e.gracefulify=p,e.createReadStream=function(t,n){return new e.ReadStream(t,n)},e.createWriteStream=function(t,n){return new e.WriteStream(t,n)};var t=e.readFile;e.readFile=function(e,n,r){"function"==typeof n&&(r=n,n=null);return function e(n,r,o){return t(n,r,function(t){!t||"EMFILE"!==t.code&&"ENFILE"!==t.code?("function"==typeof o&&o.apply(this,arguments),s()):l([e,[n,r,o]])})}(e,n,r)};var n=e.writeFile;e.writeFile=function(e,t,r,o){"function"==typeof r&&(o=r,r=null);return function e(t,r,o,i){return n(t,r,o,function(n){!n||"EMFILE"!==n.code&&"ENFILE"!==n.code?("function"==typeof i&&i.apply(this,arguments),s()):l([e,[t,r,o,i]])})}(e,t,r,o)};var i=e.appendFile;i&&(e.appendFile=function(e,t,n,r){"function"==typeof n&&(r=n,n=null);return function e(t,n,r,o){return i(t,n,r,function(i){!i||"EMFILE"!==i.code&&"ENFILE"!==i.code?("function"==typeof o&&o.apply(this,arguments),s()):l([e,[t,n,r,o]])})}(e,t,n,r)});var u=e.readdir;function c(t){return u.apply(e,t)}if(e.readdir=function(e,t,n){var r=[e];"function"!=typeof t?r.push(t):n=t;return r.push(function(e,t){t&&t.sort&&t.sort(),!e||"EMFILE"!==e.code&&"ENFILE"!==e.code?("function"==typeof n&&n.apply(this,arguments),s()):l([c,[r]])}),c(r)},"v0.8"===process.version.substr(0,4)){var f=o(e);m=f.ReadStream,E=f.WriteStream}var a=e.ReadStream;a&&(m.prototype=Object.create(a.prototype),m.prototype.open=function(){var e=this;v(e.path,e.flags,e.mode,function(t,n){t?(e.autoClose&&e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n),e.read())})});var y=e.WriteStream;y&&(E.prototype=Object.create(y.prototype),E.prototype.open=function(){var e=this;v(e.path,e.flags,e.mode,function(t,n){t?(e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n))})}),Object.defineProperty(e,"ReadStream",{get:function(){return m},set:function(e){m=e},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WriteStream",{get:function(){return E},set:function(e){E=e},enumerable:!0,configurable:!0});var d=m;Object.defineProperty(e,"FileReadStream",{get:function(){return d},set:function(e){d=e},enumerable:!0,configurable:!0});var b=E;function m(e,t){return this instanceof m?(a.apply(this,arguments),this):m.apply(Object.create(m.prototype),arguments)}function E(e,t){return this instanceof E?(y.apply(this,arguments),this):E.apply(Object.create(E.prototype),arguments)}Object.defineProperty(e,"FileWriteStream",{get:function(){return b},set:function(e){b=e},enumerable:!0,configurable:!0});var g=e.open;function v(e,t,n,r){return"function"==typeof n&&(r=n,n=null),function e(t,n,r,o){return g(t,n,r,function(i,u){!i||"EMFILE"!==i.code&&"ENFILE"!==i.code?("function"==typeof o&&o.apply(this,arguments),s()):l([e,[t,n,r,o]])})}(e,t,n,r)}return e.open=v,e}function l(t){f("ENQUEUE",t[0].name,t[1]),n[e].push(t)}function s(){var t=n[e].shift();t&&(f("RETRY",t[0].name,t[1]),t[0].apply(null,t[1]))}global[e]||c(global,n[e]),module.exports=p(i(n)),process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH&&!n.__patched&&(module.exports=p(n),n.__patched=!0);