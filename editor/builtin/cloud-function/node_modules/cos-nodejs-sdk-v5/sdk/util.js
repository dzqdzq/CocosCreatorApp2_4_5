"use strict";var e=require("fs"),r=require("crypto"),t=require("xml2js"),n=new t.Parser({explicitArray:!1,ignoreAttrs:!0}),o=new t.Builder;function i(e){return encodeURIComponent(e).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")}var a=function(){},c=function(e){var r={};for(var t in e)e.hasOwnProperty(t)&&void 0!==e[t]&&null!==e[t]&&(r[t]=e[t]);return r};function s(e){return l(e,function(e){return"object"==typeof e?s(e):e})}function u(e,r){return d(r,function(t,n){e[n]=r[n]}),e}function f(e){return e instanceof Array}function d(e,r){for(var t in e)e.hasOwnProperty(t)&&r(e[t],t)}function l(e,r){var t=f(e)?[]:{};for(var n in e)e.hasOwnProperty(n)&&(t[n]=r(e[n],n));return t}var p=function(e,r){if(r=u({},r),"getAuth"!==e&&"getV4Auth"!==e&&"getObjectUrl"!==e){var t=r.Headers||{};if(r&&"object"==typeof r){(function(){for(var e in r)r.hasOwnProperty(e)&&e.indexOf("x-cos-")>-1&&(t[e]=r[e])})();g.each({"x-cos-mfa":"MFA","Content-MD5":"ContentMD5","Content-Length":"ContentLength","Content-Type":"ContentType",Expect:"Expect",Expires:"Expires","Cache-Control":"CacheControl","Content-Disposition":"ContentDisposition","Content-Encoding":"ContentEncoding",Range:"Range","If-Modified-Since":"IfModifiedSince","If-Unmodified-Since":"IfUnmodifiedSince","If-Match":"IfMatch","If-None-Match":"IfNoneMatch","x-cos-copy-source":"CopySource","x-cos-copy-source-Range":"CopySourceRange","x-cos-metadata-directive":"MetadataDirective","x-cos-copy-source-If-Modified-Since":"CopySourceIfModifiedSince","x-cos-copy-source-If-Unmodified-Since":"CopySourceIfUnmodifiedSince","x-cos-copy-source-If-Match":"CopySourceIfMatch","x-cos-copy-source-If-None-Match":"CopySourceIfNoneMatch","x-cos-acl":"ACL","x-cos-grant-read":"GrantRead","x-cos-grant-write":"GrantWrite","x-cos-grant-full-control":"GrantFullControl","x-cos-grant-read-acp":"GrantReadAcp","x-cos-grant-write-acp":"GrantWriteAcp","x-cos-storage-class":"StorageClass","x-cos-traffic-limit":"TrafficLimit","x-cos-server-side-encryption-customer-algorithm":"SSECustomerAlgorithm","x-cos-server-side-encryption-customer-key":"SSECustomerKey","x-cos-server-side-encryption-customer-key-MD5":"SSECustomerKeyMD5","x-cos-server-side-encryption":"ServerSideEncryption","x-cos-server-side-encryption-cos-kms-key-id":"SSEKMSKeyId","x-cos-server-side-encryption-context":"SSEContext"},function(e,n){void 0!==r[e]&&(t[n]=r[e])}),r.Headers=c(t)}}return r},m=function(e){return Date.now()+(e||0)},g={noop:a,formatParams:p,apiWrapper:function(e,r){return function(t,n){var o=this;"function"==typeof t&&(n=t,t={}),t=p(e,t);var i=function(e){return e&&e.headers&&(e.headers["x-cos-version-id"]&&(e.VersionId=e.headers["x-cos-version-id"]),e.headers["x-cos-delete-marker"]&&(e.DeleteMarker=e.headers["x-cos-delete-marker"])),e},a=function(e,r){n&&n(i(e),i(r))},c=function(){if("getService"!==e&&"abortUploadTask"!==e){var r=function(e,r){var t=r.Bucket,n=r.Region,o=r.Key;if(e.indexOf("Bucket")>-1||"deleteMultipleObject"===e||"multipartList"===e||"listObjectVersions"===e){if(!t)return"Bucket";if(!n)return"Region"}else if(e.indexOf("Object")>-1||e.indexOf("multipart")>-1||"sliceUploadFile"===e||"abortUploadTask"===e){if(!t)return"Bucket";if(!n)return"Region";if(!o)return"Key"}return!1}(e,t);if(r)return"missing param "+r;if(t.Region){if(t.Region.indexOf("cos.")>-1)return'param Region should not be start with "cos."';if(!/^([a-z\d-]+)$/.test(t.Region))return"Region format error.";o.options.CompatibilityMode||-1!==t.Region.indexOf("-")||"yfb"===t.Region||"default"===t.Region||console.warn("warning: param Region format error, find help here: https://cloud.tencent.com/document/product/436/6224")}if(t.Bucket){if(!/^([a-z\d-]+)-(\d+)$/.test(t.Bucket))if(t.AppId)t.Bucket=t.Bucket+"-"+t.AppId;else{if(!o.options.AppId)return'Bucket should format as "test-1250000000".';t.Bucket=t.Bucket+"-"+o.options.AppId}t.AppId&&(console.warn('warning: AppId has been deprecated, Please put it at the end of parameter Bucket(E.g Bucket:"test-1250000000" ).'),delete t.AppId)}!o.options.UseRawKey&&t.Key&&"/"===t.Key.substr(0,1)&&(t.Key=t.Key.substr(1))}}(),s="getAuth"===e||"getV4Auth"===e||"getObjectUrl"===e||e.indexOf("Stream")>-1,u=global.Promise;if(!s&&u&&!n)return new u(function(e,i){if(n=function(r,t){r?i(r):e(t)},c)return a(g.error(new Error(c)));r.call(o,t,a)});if(c)return a(g.error(new Error(c)));var f=r.call(o,t,a);return s?f:void 0}},xml2json:function(e){var r={};return n.parseString(e,function(e,t){r=t}),r},json2xml:function(e){return o.buildObject(e)},md5:function(e,t){return r.createHash("md5").update(e).digest(t||"hex")},clearKey:c,fileSlice:function(r,t,n,o){if(r){var i=e.createReadStream(r,{start:t,end:n-1});i.isSdkCreated=!0,o(i)}else o(null)},getBodyMd5:function(e,r,t){t=t||a,e&&(r instanceof Buffer||"string"==typeof r)?t(g.md5(r)):t()},getFileMd5:function(e,t){var n=r.createHash("md5");e.on("data",function(e){n.update(e)}),e.on("error",function(e){t(g.error(e))}),e.on("end",function(){var e=n.digest("hex");t(null,e)})},binaryBase64:function(e){var r,t,n,o=[];for(r=0,t=e.length/2;r<t;r++)n=parseInt(e[2*r]+e[2*r+1],16),o.push(n);return Buffer.from(o).toString("base64")},extend:u,isArray:f,isInArray:function(e,r){for(var t=!1,n=0;n<e.length;n++)if(r===e[n]){t=!0;break}return t},makeArray:function(e){return f(e)?e:[e]},each:d,map:l,filter:function(e,r){var t=f(e),n=t?[]:{};for(var o in e)e.hasOwnProperty(o)&&r(e[o],o)&&(t?n.push(e[o]):n[o]=e[o]);return n},clone:s,uuid:function(){var e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},camSafeUrlEncode:i,throttleOnProgress:function(e,r){var t,n,o=this,i=0,a=0,c=Date.now();function s(){if(n=0,r&&"function"==typeof r){t=Date.now();var o,s=Math.max(0,Math.round((a-i)/((t-c)/1e3)*100)/100)||0;o=0===a&&0===e?1:Math.floor(a/e*100)/100||0,c=t,i=a;try{r({loaded:a,total:e,speed:s,percent:o})}catch(e){}}}return function(r,t){if(r&&(a=r.loaded,e=r.total),t)clearTimeout(n),s();else{if(n)return;n=setTimeout(s,o.options.ProgressInterval)}}},getFileSize:function(r,t,n){var o;if("sliceUploadFile"===r)return t.FilePath?(e.stat(t.FilePath,function(e,r){if(e){if(void 0===t.ContentLength)return n(e);o=t.ContentLength}else t.FileStat=r,t.FileStat.FilePath=t.FilePath,o=r.isDirectory()?0:r.size;t.ContentLength=o=o||0,n(null,o)}),void 0):(n(g.error(new Error("missing param FilePath"))),void 0);if(void 0===t.Body)return n(g.error(new Error("missing param Body"))),void 0;if("string"==typeof t.Body&&(t.Body=global.Buffer.from(t.Body)),t.Body instanceof global.Buffer)o=t.Body.length;else{if("function"!=typeof t.Body.pipe)return n(g.error(new Error("params Body format error, Only allow Buffer|Stream|String."))),void 0;o=void 0===t.ContentLength?void 0:t.ContentLength}t.ContentLength=o,n(null,o)},getSkewTime:m,callbackAfterStreamFinish:function(e,r){if(!e)return r;var t,n,o=2,i=function(e,i){(i&&!n||e||t)&&(n=i),e&&!t&&(t=e,n=null),0==--o&&r(t,n)};return e.on("error",function(e){i(e)}),e.on("finish",function(){i()}),i},error:function(e,r){var t=e;return e.message=e.message||null,"string"==typeof r?(e.error=r,e.message=r):"object"==typeof r&&null!==r&&(u(e,r),(r.code||r.name)&&(e.code=r.code||r.name),r.message&&(e.message=r.message),r.stack&&(e.stack=r.stack)),"function"==typeof Object.defineProperty&&(Object.defineProperty(e,"name",{writable:!0,enumerable:!1}),Object.defineProperty(e,"message",{enumerable:!0})),e.name=r&&r.name||e.name||e.code||"Error",e.code||(e.code=e.name),e.error||(e.error=s(t)),e},getAuth:function(e){var t,n=(e=e||{}).SecretId,o=e.SecretKey,a=e.KeyTime,c=(e.method||e.Method||"get").toLowerCase(),u=s(e.Query||e.params||{}),f=s(e.Headers||e.headers||{}),d=e.Key||"";if(e.UseRawKey?t=e.Pathname||e.pathname||"/"+d:0!==(t=e.Pathname||e.pathname||d).indexOf("/")&&(t="/"+t),!n)throw new Error("missing param SecretId");if(!o)throw new Error("missing param SecretKey");var l=function(e,r){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(r?i(n).toLowerCase():n);return t.sort(function(e,r){return(e=e.toLowerCase())===(r=r.toLowerCase())?0:e>r?1:-1})},p=function(e){var r,t,n,o=[],a=l(e);for(r=0;r<a.length;r++)n=void 0===e[t=a[r]]||null===e[t]?"":""+e[t],t=i(t).toLowerCase(),n=i(n)||"",o.push(t+"="+n);return o.join("&")},g=Math.round(m(e.SystemClockOffset)/1e3)-1,h=g,y=e.Expires||e.expires;h+=void 0===y?900:1*y||0;var v=n,x=a||g+";"+h,S=a||g+";"+h,C=l(f,!0).join(";").toLowerCase(),w=l(u,!0).join(";").toLowerCase(),k=r.createHmac("sha1",o).update(S).digest("hex"),B=[c,t,p(u),p(f),""].join("\n");B=Buffer.from(B,"utf8");var I=["sha1",x,r.createHash("sha1").update(B).digest("hex"),""].join("\n");return["q-sign-algorithm=sha1","q-ak="+v,"q-sign-time="+x,"q-key-time="+S,"q-header-list="+C,"q-url-param-list="+w,"q-signature="+r.createHmac("sha1",k).update(I).digest("hex")].join("&")},getV4Auth:function(e){if(!e.SecretId)return console.error("missing param SecretId");if(!e.SecretKey)return console.error("missing param SecretKey");if(!e.Bucket)return console.error("missing param Bucket");var t=e.Bucket,n=t.substr(0,t.lastIndexOf("-")),o=t.substr(t.lastIndexOf("-")+1),i=Math.round(Math.random()*Math.pow(2,32)),a=Math.round(Date.now()/1e3),c=a+(void 0===e.Expires?900:e.Expires),s="/"+o+"/"+n+"/"+encodeURIComponent((e.Key||"").replace(/(^\/*)/g,"")).replace(/%2F/g,"/"),u="a="+o+"&b="+n+"&k="+e.SecretId+"&t="+a+"&e="+c+"&r="+i+"&f="+s,f=r.createHmac("sha1",e.SecretKey).update(u).digest();return Buffer.concat([f,Buffer.from(u)]).toString("base64")},isBrowser:!1};module.exports=g;