var{Transform:e}=require("stream"),t=require("util"),s=require("./util");function h(t){if(!(this instanceof h))return new h(t);e.call(this,t),Object.assign(this,{totalLength:0,headerLength:0,payloadRestLength:0,header:null,chunk:Buffer.alloc(0),callback:null})}h.prototype={processChunk(e,t,s){Object.assign(this,{chunk:Buffer.concat([this.chunk,e],this.chunk.length+e.length),encoding:t,callback:s}),this.parseLength(),this.parseHeader(),this.parsePayload()},parseLength(){this.callback&&(this.totalLength&&this.headerLength||(this.chunk.length>=12?(this.totalLength=this.chunk.readInt32BE(0),this.headerLength=this.chunk.readInt32BE(4),this.payloadRestLength=this.totalLength-this.headerLength-16,this.chunk=this.chunk.slice(12)):(this.callback(),this.callback=null)))},parseHeader(){if(this.callback&&this.headerLength&&!this.header)if(this.chunk.length>=this.headerLength){for(var e={},t=0;t<this.headerLength;){var s=1*this.chunk[t],h=this.chunk.toString("ascii",t+1,t+1+s),a=this.chunk.readInt16BE(t+s+2),i=this.chunk.toString("ascii",t+s+4,t+s+4+a);e[h]=i,t+=s+4+a}this.header=e,this.chunk=this.chunk.slice(this.headerLength),this.checkErrorHeader()}else this.callback(),this.callback=null},parsePayload(){var e=this;this.callback&&(this.chunk.length<=this.payloadRestLength?(this.payloadRestLength-=this.chunk.length,this.pushData(this.chunk),this.chunk=Buffer.alloc(0)):this.chunk.length<this.payloadRestLength+4?(this.pushData(this.chunk.slice(0,this.payloadRestLength)),this.chunk=this.chunk.slice(this.payloadRestLength),this.payloadRestLength=0):(this.pushData(this.chunk.slice(0,this.payloadRestLength)),this.chunk=this.chunk.slice(this.payloadRestLength+4),this.totalLength=0,this.headerLength=0,this.payloadRestLength=0,this.header=null),!this.chunk.length||0===this.payloadRestLength&&this.chunk.length<4?(this.callback(),this.callback=null):process.nextTick(function(){e.processChunk(Buffer.alloc(0),e.encoding,e.callback)}))},pushData(e){if("Records"===this.header[":event-type"])this.push(e),this.emit("message:records",e);else if("Progress"===this.header[":event-type"]){var t=s.xml2json(e.toString()).Progress;this.emit("message:progress",t)}else if("Stats"===this.header[":event-type"]){var h=s.xml2json(e.toString()).Stats;this.emit("message:stats",h)}else if("error"===this.header[":event-type"]){var a=this.header[":error-code"],i=this.header[":error-message"],r=new Error(i);r.message=i,r.name=r.code=a,this.emit("message:error",r)}else this.emit("message:"+this.header[":event-type"].toLowerCase())},checkErrorHeader(){"error"===this.header[":message-type"]&&(this.callback(this.header),this.callback=null)},_transform(e,t,s){this.processChunk(e,t,s)},_flush(e){this.processChunk(Buffer.alloc(0),this.encoding,e)}},t.inherits(h,e),h.parseBody=function(e){for(var t={},h={records:[]};e.length;){var a,i=e.readInt32BE(0),r=e.readInt32BE(4),n=i-r-16,c=0;for(e=e.slice(12);c<r;){var l=1*e[c],o=e.toString("ascii",c+1,c+1+l),u=e.readInt16BE(c+l+2),g=e.toString("ascii",c+l+4,c+l+4+u);t[o]=g,c+=l+4+u}if("Records"===t[":event-type"])a=e.slice(c,c+n),h.records.push(a);else if("Stats"===t[":event-type"])a=e.slice(c,c+n),h.stats=s.xml2json(a.toString()).Stats;else if("error"===t[":event-type"]){var d=t[":error-code"],k=t[":error-message"],p=new Error(k);p.message=k,p.name=p.code=d,h.error=p}else["Progress","Continuation","End"].includes(t[":event-type"]);e=e.slice(c+n+4)}return h},module.exports=h;