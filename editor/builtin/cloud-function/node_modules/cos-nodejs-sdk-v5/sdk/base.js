var e=require("../package.json"),t=require("request"),o=require("mime-types"),n=require("stream"),r=require("./util"),a=require("fs");function s(e,t){var o,s=e.Query||{};s["response-content-type"]=e.ResponseContentType,s["response-content-language"]=e.ResponseContentLanguage,s["response-expires"]=e.ResponseExpires,s["response-cache-control"]=e.ResponseCacheControl,s["response-content-disposition"]=e.ResponseContentDisposition,s["response-content-encoding"]=e.ResponseContentEncoding;var i=this,c=e.Output;e.ReturnStream?(c=new n.PassThrough,o="stream"):c&&"string"==typeof c?(c=a.createWriteStream(c),o="stream"):o=c&&"function"==typeof c.pipe?"stream":"buffer";var u=e.onProgress,d=function(){var e,t=Date.now(),o=0,n=0,r=0,a=function(){if(e=0,u&&"function"==typeof u){var a=Date.now(),s=parseInt((n-o)/((a-t)/1e3)*100)/100||0,i=parseInt(n/r*100)/100||0;t=a,o=n;try{u({loaded:n,total:r,speed:s,percent:i})}catch(e){}}};return function(t,o){if(t&&t.loaded&&(n=t.loaded,r=t.total),o)clearTimeout(e),a();else{if(e)return;e=setTimeout(a,i.options.ProgressInterval||1e3)}}}();if(h.call(this,{Action:"name/cos:GetObject",method:"GET",Bucket:e.Bucket,Region:e.Region,Key:e.Key,VersionId:e.VersionId,headers:e.Headers,qs:s,rawBody:!0,outputStream:c,onDownloadProgress:d},function(n,a){if(d(null,!0),n){var s=n.statusCode;return e.Headers["If-Modified-Since"]&&s&&304===s?t(null,{NotModified:!0}):(c&&c.emit("error",n),t(n))}var i={};a.body&&("buffer"===o?i.Body=Buffer.from(a.body):"string"===o&&(i.Body=a.body)),a.headers&&a.headers.etag&&(i.ETag=a.headers&&a.headers.etag),r.extend(i,{statusCode:a.statusCode,headers:a.headers}),t(null,i)}),e.ReturnStream)return c}function i(e,t){if(!e.SelectType)return t(r.error(new Error("missing param SelectType")));var o,a=e.SelectRequest||{},s=r.json2xml({SelectRequest:a}),i=e.Headers;i["Content-Type"]="application/xml",i["Content-MD5"]=r.binaryBase64(r.md5(s));var c={},u=require("./select-stream");return e.ReturnStream&&"raw"===e.DataType?o=new n.PassThrough:((o=new u).on("message:progress",function(t){"function"==typeof e.onProgress&&e.onProgress(t)}),o.on("message:stats",function(e){c.stats=e}),o.on("message:error",function(e){c.error=e})),h.call(this,{Interface:"selectObjectContent",Action:"name/cos:GetObject",method:"POST",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,action:"select",qs:{"select-type":e.SelectType},VersionId:e.VersionId,body:s,rawBody:!0,outputStream:o},function(e,n){if(e&&204===e.statusCode)return t(null,{statusCode:e.statusCode});if(e)return o&&o.emit("error",e),t(e);if(c.error)return t(r.extend(c.error,{statusCode:n.statusCode,headers:n.headers}));var a={statusCode:n.statusCode,headers:n.headers};c.stats&&(a.Stats=c.stats),c.records&&(a.Payload=Buffer.concat(c.records)),t(null,a)}),e.ReturnStream||"raw"===e.DataType||(c.records=[],o.pipe(new n.Writable({write:function(e,t,o){c.records.push(e),o()},writev:function(e,t,o){e.forEach(function(t){c.records.push(e)}),o()}})),o.pipe(o)),e.ReturnStream?o:void 0}function c(e){var t={GrantFullControl:[],GrantWrite:[],GrantRead:[],GrantReadAcp:[],GrantWriteAcp:[],ACL:""},o={FULL_CONTROL:"GrantFullControl",WRITE:"GrantWrite",READ:"GrantRead",READ_ACP:"GrantReadAcp",WRITE_ACP:"GrantWriteAcp"},n=(e&&e.AccessControlList||{}).Grant;n&&(n=r.isArray(n)?n:[n]);var a={READ:0,WRITE:0,FULL_CONTROL:0};return n&&n.length&&r.each(n,function(n){"qcs::cam::anyone:anyone"===n.Grantee.ID||"http://cam.qcloud.com/groups/global/AllUsers"===n.Grantee.URI?a[n.Permission]=1:n.Grantee.ID!==e.Owner.ID&&t[o[n.Permission]].push('id="'+n.Grantee.ID+'"')}),a.FULL_CONTROL||a.WRITE&&a.READ?t.ACL="public-read-write":a.READ?t.ACL="public-read":t.ACL="private",r.each(o,function(e){t[e]=u(t[e].join(","))}),t}function u(e){var t,o,n=e.split(","),r={};for(t=0;t<n.length;)r[o=n[t].trim()]?n.splice(t,1):(r[o]=!0,n[t]=o,t++);return n.join(",")}function d(e){var t=e.bucket,o=t.substr(0,t.lastIndexOf("-")),n=t.substr(t.lastIndexOf("-")+1),a=e.domain,s=e.region,i=e.object,c=e.protocol||(r.isBrowser&&"http:"===location.protocol?"http:":"https:");a||(a=["cn-south","cn-south-2","cn-north","cn-east","cn-southwest","sg"].indexOf(s)>-1?"{Region}.myqcloud.com":"cos.{Region}.myqcloud.com",e.ForcePathStyle||(a="{Bucket}."+a)),a=(a=a.replace(/\{\{AppId\}\}/gi,n).replace(/\{\{Bucket\}\}/gi,o).replace(/\{\{Region\}\}/gi,s).replace(/\{\{.*?\}\}/gi,"")).replace(/\{AppId\}/gi,n).replace(/\{BucketName\}/gi,o).replace(/\{Bucket\}/gi,t).replace(/\{Region\}/gi,s).replace(/\{.*?\}/gi,""),/^[a-zA-Z]+:\/\//.test(a)||(a=c+"//"+a),"/"===a.slice(-1)&&(a=a.slice(0,-1));var u=a;return e.ForcePathStyle&&(u+="/"+t),u+="/",i&&(u+=r.camSafeUrlEncode(i).replace(/%2F/g,"/")),e.isLocation&&(u=u.replace(/^https?:\/\//,"")),u}function l(e,t){var o=r.clone(e.Headers);r.each(o,function(e,t){(""===e||["content-type","cache-control","expires"].indexOf(t.toLowerCase()))&&delete o[t]});var n=!1,a=function(e,o){n||(n=!0,t&&t(e,o))},s=this,i=e.Bucket||"",c=e.Region||"",u=e.Key||"";s.options.ForcePathStyle&&i&&(u=i+"/"+u);var d="/"+u,l={},h=e.Scope;if(!h){var g=e.Action||"",f=e.ResourceKey||e.Key||"";h=e.Scope||[{action:g,bucket:i,region:c,prefix:f}]}var C=r.md5(JSON.stringify(h));s._StsCache=s._StsCache||[],function(){var e,t;for(e=s._StsCache.length-1;e>=0;e--){t=s._StsCache[e];var o=Math.round(r.getSkewTime(s.options.SystemClockOffset)/1e3)+30;if(t.StartTime&&o<t.StartTime||o>=t.ExpiredTime)s._StsCache.splice(e,1);else if(!t.ScopeLimit||t.ScopeLimit&&t.ScopeKey===C){l=t;break}}}();var p=function(){var t=l.StartTime&&l.ExpiredTime?l.StartTime+";"+l.ExpiredTime:"",n={Authorization:r.getAuth({SecretId:l.TmpSecretId,SecretKey:l.TmpSecretKey,Method:e.Method,Pathname:d,Query:e.Query,Headers:o,Expires:e.Expires,UseRawKey:s.options.UseRawKey,SystemClockOffset:s.options.SystemClockOffset,KeyTime:t}),SecurityToken:l.SecurityToken||l.XCosSecurityToken||"",Token:l.Token||"",ClientIP:l.ClientIP||"",ClientUA:l.ClientUA||""};a(null,n)},m=function(e){if(e.Authorization){var t=!1,o=e.Authorization;if(o)if(o.indexOf(" ")>-1)t=!1;else if(o.indexOf("q-sign-algorithm=")>-1&&o.indexOf("q-ak=")>-1&&o.indexOf("q-sign-time=")>-1&&o.indexOf("q-key-time=")>-1&&o.indexOf("q-url-param-list=")>-1)t=!0;else try{(o=Buffer.from(o,"base64").toString()).indexOf("a=")>-1&&o.indexOf("k=")>-1&&o.indexOf("t=")>-1&&o.indexOf("r=")>-1&&o.indexOf("b=")>-1&&(t=!0)}catch(e){}if(!t)return r.error(new Error("getAuthorization callback params format error"))}else{if(!e.TmpSecretId)return r.error(new Error('getAuthorization callback params missing "TmpSecretId"'));if(!e.TmpSecretKey)return r.error(new Error('getAuthorization callback params missing "TmpSecretKey"'));if(!e.SecurityToken&&!e.XCosSecurityToken)return r.error(new Error('getAuthorization callback params missing "SecurityToken"'));if(!e.ExpiredTime)return r.error(new Error('getAuthorization callback params missing "ExpiredTime"'));if(e.ExpiredTime&&10!==e.ExpiredTime.toString().length)return r.error(new Error('getAuthorization callback params "ExpiredTime" should be 10 digits'));if(e.StartTime&&10!==e.StartTime.toString().length)return r.error(new Error('getAuthorization callback params "StartTime" should be 10 StartTime'))}return!1};if(l.ExpiredTime&&l.ExpiredTime-r.getSkewTime(s.options.SystemClockOffset)/1e3>60)p();else if(s.options.getAuthorization)s.options.getAuthorization.call(s,{Bucket:i,Region:c,Method:e.Method,Key:u,Pathname:d,Query:e.Query,Headers:o,Scope:h,SystemClockOffset:s.options.SystemClockOffset},function(e){"string"==typeof e&&(e={Authorization:e});var t=m(e);if(t)return a(t);e.Authorization?a(null,e):((l=e||{}).Scope=h,l.ScopeKey=C,s._StsCache.push(l),p())});else{if(!s.options.getSTS)return function(){var t={Authorization:r.getAuth({SecretId:e.SecretId||s.options.SecretId,SecretKey:e.SecretKey||s.options.SecretKey,Method:e.Method,Pathname:d,Query:e.Query,Headers:o,Expires:e.Expires,UseRawKey:s.options.UseRawKey,SystemClockOffset:s.options.SystemClockOffset}),SecurityToken:s.options.SecurityToken||s.options.XCosSecurityToken};return a(null,t),t}();s.options.getSTS.call(s,{Bucket:i,Region:c},function(e){(l=e||{}).Scope=h,l.ScopeKey=C,l.TmpSecretId||(l.TmpSecretId=l.SecretId),l.TmpSecretKey||(l.TmpSecretKey=l.SecretKey);var t=m(l);if(t)return a(t);s._StsCache.push(l),p()})}return""}function h(n,a){var s=this;!n.headers&&(n.headers={}),n.headers["User-Agent"]=s.options.UserAgent||"cos-nodejs-sdk-v5-"+e.version,!n.qs&&(n.qs={}),n.VersionId&&(n.qs.versionId=n.VersionId),n.qs=r.clearKey(n.qs),n.headers&&(n.headers=r.clearKey(n.headers)),n.qs&&(n.qs=r.clearKey(n.qs));var i=r.clone(n.qs);n.action&&(i[n.action]="");var c=function(e){var u=s.options.SystemClockOffset;l.call(s,{Bucket:n.Bucket||"",Region:n.Region||"",Method:n.method,Key:n.Key,Query:i,Headers:n.headers,Action:n.Action,ResourceKey:n.ResourceKey,Scope:n.Scope},function(i,l){if(i)return a(i),void 0;n.AuthData=l,function(e,n){var a=this,s=e.TaskId;if(s&&!a._isRunningTask(s))return;var i,c=e.Bucket,u=e.Region,l=e.Key,h=e.method||"GET",g=e.url,f=e.body,C=e.json,p=e.rawBody;f&&"function"==typeof f.pipe&&(i=f,f=null);g=g||d({ForcePathStyle:a.options.ForcePathStyle,protocol:a.options.Protocol,domain:a.options.Domain,bucket:c,region:u,object:l}),e.action&&(g=g+"?"+e.action);var m={method:h,url:g,headers:e.headers,qs:e.qs,body:f,json:C};m.headers.Authorization=e.AuthData.Authorization,e.AuthData.Token&&(m.headers.token=e.AuthData.Token),e.AuthData.ClientIP&&(m.headers.clientIP=e.AuthData.ClientIP),e.AuthData.ClientUA&&(m.headers.clientUA=e.AuthData.ClientUA),e.AuthData.SecurityToken&&(m.headers["x-cos-security-token"]=e.AuthData.SecurityToken),m.headers&&(m.headers=r.clearKey(m.headers)),m=r.clearKey(m);var y=this.options.Ip;y&&(m.url=m.url.replace(/^(https?:\/\/)([^\/]+)/,function(e,t,o){return m.headers.Host=o,t+y}));!0!==this.options.StrictSsl&&(m.strictSSL=this.options.StrictSsl);this.options.Proxy&&(m.proxy=this.options.Proxy);this.options.Timeout&&(m.timeout=this.options.Timeout);this.options.KeepAlive&&(m.forever=!0);if(i){var k=!1;r.each(m.headers,function(e,t){"content-type"===t.toLowerCase()&&(k=!0)}),!k&&i.readable&&i.path&&i.mode&&!o.lookup(i.path)&&(m.headers["Content-Type"]="application/octet-stream")}e.outputStream&&(n=r.callbackAfterStreamFinish(e.outputStream,n));a.emit("before-send",m);var R,B,S=t(m),v=function(e,t){if(s&&a.off("inner-kill-task",b),!B){B=!0;var o={};R&&R.statusCode&&(o.statusCode=R.statusCode),R&&R.headers&&(o.headers=R.headers),e?(e=r.extend(e||{},o),n(e,null)):(t=r.extend(t||{},o),n(null,t)),S&&(S.removeAllListeners&&S.removeAllListeners(),S=null)}},A=function(e){try{C=r.xml2json(e)||{}}catch(t){C=e||{}}return C},T=function(){try{Object.defineProperty(S.req.connection,"_lastBytesWritten",{enumerable:!0,configurable:!0,writable:!0,value:S.req.connection.bytesWritten})}catch(e){}};S.on("error",function(e){T(),v(r.error(e))}),S.on("response",function(t){R=t;var o=t.headers["content-length"]||0,n=[],a=t.statusCode,s=2===Math.floor(a/100);if(s&&e.outputStream)S.on("end",function(){v(null,{})});else if(o>=process.binding("buffer").kMaxLength&&"HEAD"!==m.method)v(r.error(new Error("file size large than "+process.binding("buffer").kMaxLength+', please use "Output" Stream to getObject.')));else{S.on("data",function(e){n.push(e)}),S.on("end",function(){var o;try{var a=Buffer.concat(n)}catch(e){return v(r.error(e)),void 0}var i=a.toString(),c=function(o,n){var a=n&&n.Error;return a=a?r.error(o,{code:a.Code,message:a.Message,error:a,RequestId:a.RequestId,Scope:e.Scope}):t.statusCode?r.error(o,{code:t.statusCode,message:t.statusMessage}):r.error(o,{message:t.statusMessage||"statusCode error"})};s?p?v(null,{body:a}):a.length?(o=A(a.toString()))&&o.Error?v(c(new Error,o)):v(null,o):v(null,{}):(i&&(o=A(i)),v(c(new Error,o)));n=null})}});var b=function(e){e.TaskId===s&&(i&&i.isSdkCreated&&i.close&&i.close(),S&&S.abort&&S.abort(),a.off("inner-kill-task",b))};if(s&&a.on("inner-kill-task",b),S.once("end",function(){T()}),e.onProgress&&"function"==typeof e.onProgress){var O=m.headers["Content-Length"],E=Date.now(),x=0;S.on("drain",function(){var t=Date.now(),o=0;try{o=S.req.connection.bytesWritten-S.req._header.length-(S.req.connection._lastBytesWritten||0)}catch(e){}var n=O,r=parseInt((o-x)/((t-E)/1e3)*100)/100||0,a=parseInt(o/n*100)/100||0;E=t,x=o,e.onProgress({loaded:o,total:n,speed:r,percent:a})})}if(e.onDownloadProgress&&"function"==typeof e.onDownloadProgress){var E=Date.now(),x=0,D=0,P=0;S.on("response",function(t){P=t.headers["content-length"],S.on("data",function(t){D+=t.length;var o=Date.now(),n=parseInt((D-x)/((o-E)/1e3)*100)/100||0,r=parseInt(D/P*100)/100||0;E=o,x=D,e.onDownloadProgress({loaded:D,total:P,speed:n,percent:r})})})}i&&(i.on("error",function(e){S&&S.abort&&S.abort(),v(e)}),i.pipe(S));e.outputStream&&(e.outputStream.on("error",function(e){S&&S.abort&&S.abort(),v(e)}),S.pipe(e.outputStream));return S}.call(s,n,function(t,o){t&&!n.outputStream&&e<2&&(u!==s.options.SystemClockOffset||function(e){var t=!1,o=!1,n=e.headers&&(e.headers.date||e.headers.Date)||e.error&&e.error.ServerTime;try{var a=e.error.Code,s=e.error.Message;("RequestTimeTooSkewed"===a||"AccessDenied"===a&&"Request has expired"===s)&&(o=!0)}catch(e){}if(e)if(o&&n){var i=Date.parse(n);this.options.CorrectClockSkew&&Math.abs(r.getSkewTime(this.options.SystemClockOffset)-i)>=3e4&&(console.error("error: Local time is too skewed."),this.options.SystemClockOffset=i-Date.now(),t=!0)}else 5===Math.floor(e.statusCode/100)&&(t=!0);return t}.call(s,t))?(n.headers&&(delete n.headers.Authorization,delete n.headers.token,delete n.headers.clientIP,delete n.headers.clientUA,delete n.headers["x-cos-security-token"]),c(e+1)):a(t,o)})})};c(1)}var g={getService:function(e,t){"function"==typeof e&&(t=e,e={});var o=this.options.Protocol||(r.isBrowser&&"http:"===location.protocol?"http:":"https:"),n=this.options.ServiceDomain,a=e.AppId||this.options.appId,s=e.Region;n?(n=n.replace(/\{\{AppId\}\}/gi,a||"").replace(/\{\{Region\}\}/gi,s||"").replace(/\{\{.*?\}\}/gi,""),/^[a-zA-Z]+:\/\//.test(n)||(n=o+"//"+n),"/"===n.slice(-1)&&(n=n.slice(0,-1))):n=s?o+"//cos."+s+".myqcloud.com":o+"//service.cos.myqcloud.com",h.call(this,{Action:"name/cos:GetService",url:n,method:"GET",headers:e.Headers},function(e,o){if(e)return t(e);var n=o&&o.ListAllMyBucketsResult&&o.ListAllMyBucketsResult.Buckets&&o.ListAllMyBucketsResult.Buckets.Bucket||[];n=r.isArray(n)?n:[n];var a=o&&o.ListAllMyBucketsResult&&o.ListAllMyBucketsResult.Owner||{};t(null,{Buckets:n,Owner:a,statusCode:o.statusCode,headers:o.headers})})},putBucket:function(e,t){var o=this,n="";if(e.BucketAZConfig){var a={BucketAZConfig:e.BucketAZConfig};n=r.json2xml({CreateBucketConfiguration:a})}h.call(this,{Action:"name/cos:PutBucket",method:"PUT",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,body:n},function(n,r){if(n)return t(n);var a=d({protocol:o.options.Protocol,domain:o.options.Domain,bucket:e.Bucket,region:e.Region,isLocation:!0});t(null,{Location:a,statusCode:r.statusCode,headers:r.headers})})},headBucket:function(e,t){h.call(this,{Action:"name/cos:HeadBucket",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,method:"HEAD"},t)},getBucket:function(e,t){var o={};o.prefix=e.Prefix||"",o.delimiter=e.Delimiter,o.marker=e.Marker,o["max-keys"]=e.MaxKeys,o["encoding-type"]=e.EncodingType,h.call(this,{Action:"name/cos:GetBucket",ResourceKey:o.prefix,method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,qs:o},function(e,o){if(e)return t(e);var n=o.ListBucketResult||{},a=n.Contents||[],s=n.CommonPrefixes||[];a=r.isArray(a)?a:[a],s=r.isArray(s)?s:[s];var i=r.clone(n);r.extend(i,{Contents:a,CommonPrefixes:s,statusCode:o.statusCode,headers:o.headers}),t(null,i)})},deleteBucket:function(e,t){h.call(this,{Action:"name/cos:DeleteBucket",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,method:"DELETE"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},putBucketAcl:function(e,t){var o=e.Headers,n="";if(e.AccessControlPolicy){var a=r.clone(e.AccessControlPolicy||{}),s=a.Grants||a.Grant;s=r.isArray(s)?s:[s],delete a.Grant,delete a.Grants,a.AccessControlList={Grant:s},n=r.json2xml({AccessControlPolicy:a}),o["Content-Type"]="application/xml",o["Content-MD5"]=r.binaryBase64(r.md5(n))}r.each(o,function(e,t){0===t.indexOf("x-cos-grant-")&&(o[t]=u(o[t]))}),h.call(this,{Action:"name/cos:PutBucketACL",method:"PUT",Bucket:e.Bucket,Region:e.Region,headers:o,action:"acl",body:n},function(e,o){if(e)return t(e);t(null,{statusCode:o.statusCode,headers:o.headers})})},getBucketAcl:function(e,t){h.call(this,{Action:"name/cos:GetBucketACL",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"acl"},function(e,o){if(e)return t(e);var n=o.AccessControlPolicy||{},a=n.Owner||{},s=n.AccessControlList.Grant||[];s=r.isArray(s)?s:[s];var i=c(n);o.headers&&o.headers["x-cos-acl"]&&(i.ACL=o.headers["x-cos-acl"]),i=r.extend(i,{Owner:a,Grants:s,statusCode:o.statusCode,headers:o.headers}),t(null,i)})},putBucketCors:function(e,t){var o=(e.CORSConfiguration||{}).CORSRules||e.CORSRules||[];o=r.clone(r.isArray(o)?o:[o]),r.each(o,function(e){r.each(["AllowedOrigin","AllowedHeader","AllowedMethod","ExposeHeader"],function(t,o){var n=t+"s",a=e[n]||e[t]||[];delete e[n],e[t]=r.isArray(a)?a:[a]})});var n=r.json2xml({CORSConfiguration:{CORSRule:o}}),a=e.Headers;a["Content-Type"]="application/xml",a["Content-MD5"]=r.binaryBase64(r.md5(n)),h.call(this,{Action:"name/cos:PutBucketCORS",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:n,action:"cors",headers:a},function(e,o){if(e)return t(e);t(null,{statusCode:o.statusCode,headers:o.headers})})},getBucketCors:function(e,t){h.call(this,{Action:"name/cos:GetBucketCORS",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"cors"},function(e,o){if(e)if(404===e.statusCode&&e.error&&"NoSuchCORSConfiguration"===e.error.Code){var n={CORSRules:[],statusCode:e.statusCode};e.headers&&(n.headers=e.headers),t(null,n)}else t(e);else{var a=o.CORSConfiguration||{},s=a.CORSRules||a.CORSRule||[];s=r.clone(r.isArray(s)?s:[s]),r.each(s,function(e){r.each(["AllowedOrigin","AllowedHeader","AllowedMethod","ExposeHeader"],function(t,o){var n=t+"s",a=e[n]||e[t]||[];delete e[t],e[n]=r.isArray(a)?a:[a]})}),t(null,{CORSRules:s,statusCode:o.statusCode,headers:o.headers})}})},deleteBucketCors:function(e,t){h.call(this,{Action:"name/cos:DeleteBucketCORS",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"cors"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode||e.statusCode,headers:o.headers}),void 0)})},getBucketLocation:function(e,t){h.call(this,{Action:"name/cos:GetBucketLocation",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"location"},t)},getBucketPolicy:function(e,t){h.call(this,{Action:"name/cos:GetBucketPolicy",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"policy",rawBody:!0},function(e,o){if(e)return e.statusCode&&403===e.statusCode?t(r.error(e,{ErrorStatus:"Access Denied"})):e.statusCode&&405===e.statusCode?t(r.error(e,{ErrorStatus:"Method Not Allowed"})):e.statusCode&&404===e.statusCode?t(r.error(e,{ErrorStatus:"Policy Not Found"})):t(e);var n={};try{n=JSON.parse(o.body)}catch(e){}t(null,{Policy:n,statusCode:o.statusCode,headers:o.headers})})},putBucketPolicy:function(e,t){var o=e.Policy;try{"string"==typeof o&&(o=JSON.parse(o))}catch(e){}if(!o||"string"==typeof o)return t(r.error(new Error("Policy format error")));var n=JSON.stringify(o);o.version||(o.version="2.0");var a=e.Headers;a["Content-Type"]="application/json",a["Content-MD5"]=r.binaryBase64(r.md5(n)),h.call(this,{Action:"name/cos:PutBucketPolicy",method:"PUT",Bucket:e.Bucket,Region:e.Region,action:"policy",body:n,headers:a},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},deleteBucketPolicy:function(e,t){h.call(this,{Action:"name/cos:DeleteBucketPolicy",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"policy"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode||e.statusCode,headers:o.headers}),void 0)})},putBucketTagging:function(e,t){var o=e.Tagging||{},n=o.TagSet||o.Tags||e.Tags||[];n=r.clone(r.isArray(n)?n:[n]);var a=r.json2xml({Tagging:{TagSet:{Tag:n}}}),s=e.Headers;s["Content-Type"]="application/xml",s["Content-MD5"]=r.binaryBase64(r.md5(a)),h.call(this,{Action:"name/cos:PutBucketTagging",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:a,action:"tagging",headers:s},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketTagging:function(e,t){h.call(this,{Action:"name/cos:GetBucketTagging",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"tagging"},function(e,o){if(e)if(404!==e.statusCode||!e.error||"Not Found"!==e.error&&"NoSuchTagSet"!==e.error.Code)t(e);else{var n={Tags:[],statusCode:e.statusCode};e.headers&&(n.headers=e.headers),t(null,n)}else{var a=[];try{a=o.Tagging.TagSet.Tag||[]}catch(e){}a=r.clone(r.isArray(a)?a:[a]),t(null,{Tags:a,statusCode:o.statusCode,headers:o.headers})}})},deleteBucketTagging:function(e,t){h.call(this,{Action:"name/cos:DeleteBucketTagging",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"tagging"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},putBucketLifecycle:function(e,t){var o=(e.LifecycleConfiguration||{}).Rules||e.Rules||[];o=r.clone(o);var n=r.json2xml({LifecycleConfiguration:{Rule:o}}),a=e.Headers;a["Content-Type"]="application/xml",a["Content-MD5"]=r.binaryBase64(r.md5(n)),h.call(this,{Action:"name/cos:PutBucketLifecycle",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:n,action:"lifecycle",headers:a},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketLifecycle:function(e,t){h.call(this,{Action:"name/cos:GetBucketLifecycle",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"lifecycle"},function(e,o){if(e)if(404===e.statusCode&&e.error&&"NoSuchLifecycleConfiguration"===e.error.Code){var n={Rules:[],statusCode:e.statusCode};e.headers&&(n.headers=e.headers),t(null,n)}else t(e);else{var a=[];try{a=o.LifecycleConfiguration.Rule||[]}catch(e){}a=r.clone(r.isArray(a)?a:[a]),t(null,{Rules:a,statusCode:o.statusCode,headers:o.headers})}})},deleteBucketLifecycle:function(e,t){h.call(this,{Action:"name/cos:DeleteBucketLifecycle",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"lifecycle"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},putBucketVersioning:function(e,t){if(!e.VersioningConfiguration)return t(r.error(new Error("missing param VersioningConfiguration"))),void 0;var o=e.VersioningConfiguration||{},n=r.json2xml({VersioningConfiguration:o}),a=e.Headers;a["Content-Type"]="application/xml",a["Content-MD5"]=r.binaryBase64(r.md5(n)),h.call(this,{Action:"name/cos:PutBucketVersioning",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:n,action:"versioning",headers:a},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketVersioning:function(e,t){h.call(this,{Action:"name/cos:GetBucketVersioning",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"versioning"},function(e,o){e||!o.VersioningConfiguration&&(o.VersioningConfiguration={}),t(e,o)})},putBucketReplication:function(e,t){var o=r.clone(e.ReplicationConfiguration),n=r.json2xml({ReplicationConfiguration:o});n=(n=n.replace(/<(\/?)Rules>/gi,"<$1Rule>")).replace(/<(\/?)Tags>/gi,"<$1Tag>");var a=e.Headers;a["Content-Type"]="application/xml",a["Content-MD5"]=r.binaryBase64(r.md5(n)),h.call(this,{Action:"name/cos:PutBucketReplication",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:n,action:"replication",headers:a},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketReplication:function(e,t){h.call(this,{Action:"name/cos:GetBucketReplication",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"replication"},function(e,o){if(e)if(404!==e.statusCode||!e.error||"Not Found"!==e.error&&"ReplicationConfigurationnotFoundError"!==e.error.Code)t(e);else{var n={ReplicationConfiguration:{Rules:[]},statusCode:e.statusCode};e.headers&&(n.headers=e.headers),t(null,n)}else e||!o.ReplicationConfiguration&&(o.ReplicationConfiguration={}),o.ReplicationConfiguration.Rule&&(o.ReplicationConfiguration.Rules=r.makeArray(o.ReplicationConfiguration.Rule),delete o.ReplicationConfiguration.Rule),t(e,o)})},deleteBucketReplication:function(e,t){h.call(this,{Action:"name/cos:DeleteBucketReplication",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"replication"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},putBucketWebsite:function(e,t){if(!e.WebsiteConfiguration)return t(r.error(new Error("missing param WebsiteConfiguration"))),void 0;var o=r.clone(e.WebsiteConfiguration||{}),n=o.RoutingRules||o.RoutingRule||[];n=r.isArray(n)?n:[n],delete o.RoutingRule,delete o.RoutingRules,n.length&&(o.RoutingRules={RoutingRule:n});var a=r.json2xml({WebsiteConfiguration:o}),s=e.Headers;s["Content-Type"]="application/xml",s["Content-MD5"]=r.binaryBase64(r.md5(a)),h.call(this,{Action:"name/cos:PutBucketWebsite",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:a,action:"website",headers:s},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketWebsite:function(e,t){h.call(this,{Action:"name/cos:GetBucketWebsite",method:"GET",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,action:"website"},function(e,o){if(e)if(404===e.statusCode&&"NoSuchWebsiteConfiguration"===e.error.Code){var n={WebsiteConfiguration:{},statusCode:e.statusCode};e.headers&&(n.headers=e.headers),t(null,n)}else t(e);else{var a=o.WebsiteConfiguration||{};if(a.RoutingRules){var s=r.clone(a.RoutingRules.RoutingRule||[]);s=r.makeArray(s),a.RoutingRules=s}t(null,{WebsiteConfiguration:a,statusCode:o.statusCode,headers:o.headers})}})},deleteBucketWebsite:function(e,t){h.call(this,{Action:"name/cos:DeleteBucketWebsite",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"website"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},putBucketReferer:function(e,t){if(!e.RefererConfiguration)return t(r.error(new Error("missing param RefererConfiguration"))),void 0;var o=r.clone(e.RefererConfiguration||{}),n=o.DomainList||{},a=n.Domains||n.Domain||[];(a=r.isArray(a)?a:[a]).length&&(o.DomainList={Domain:a});var s=r.json2xml({RefererConfiguration:o}),i=e.Headers;i["Content-Type"]="application/xml",i["Content-MD5"]=r.binaryBase64(r.md5(s)),h.call(this,{Action:"name/cos:PutBucketReferer",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:s,action:"referer",headers:i},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketReferer:function(e,t){h.call(this,{Action:"name/cos:GetBucketReferer",method:"GET",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,action:"referer"},function(e,o){if(e)if(404===e.statusCode&&"NoSuchRefererConfiguration"===e.error.Code){var n={WebsiteConfiguration:{},statusCode:e.statusCode};e.headers&&(n.headers=e.headers),t(null,n)}else t(e);else{var a=o.RefererConfiguration||{};if(a.DomainList){var s=r.clone(a.DomainList.Domain||[]);s=r.makeArray(s),a.DomainList={Domains:s}}t(null,{RefererConfiguration:a,statusCode:o.statusCode,headers:o.headers})}})},putBucketDomain:function(e,t){var o=(e.DomainConfiguration||{}).DomainRule||e.DomainRule||[];o=r.clone(o);var n=r.json2xml({DomainConfiguration:{DomainRule:o}}),a=e.Headers;a["Content-Type"]="application/xml",a["Content-MD5"]=r.binaryBase64(r.md5(n)),h.call(this,{Action:"name/cos:PutBucketDomain",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:n,action:"domain",headers:a},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketDomain:function(e,t){h.call(this,{Action:"name/cos:GetBucketDomain",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"domain"},function(e,o){if(e)return t(e);var n=[];try{n=o.DomainConfiguration.DomainRule||[]}catch(e){}n=r.clone(r.isArray(n)?n:[n]),t(null,{DomainRule:n,statusCode:o.statusCode,headers:o.headers})})},deleteBucketDomain:function(e,t){h.call(this,{Action:"name/cos:DeleteBucketDomain",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"domain"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},putBucketOrigin:function(e,t){var o=(e.OriginConfiguration||{}).OriginRule||e.OriginRule||[];o=r.clone(o);var n=r.json2xml({OriginConfiguration:{OriginRule:o}}),a=e.Headers;a["Content-Type"]="application/xml",a["Content-MD5"]=r.binaryBase64(r.md5(n)),h.call(this,{Action:"name/cos:PutBucketOrigin",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:n,action:"origin",headers:a},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketOrigin:function(e,t){h.call(this,{Action:"name/cos:GetBucketOrigin",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"origin"},function(e,o){if(e)return t(e);var n=[];try{n=o.OriginConfiguration.OriginRule||[]}catch(e){}n=r.clone(r.isArray(n)?n:[n]),t(null,{OriginRule:n,statusCode:o.statusCode,headers:o.headers})})},deleteBucketOrigin:function(e,t){h.call(this,{Action:"name/cos:DeleteBucketOrigin",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"origin"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},putBucketLogging:function(e,t){var o=r.json2xml({BucketLoggingStatus:e.BucketLoggingStatus||""}),n=e.Headers;n["Content-Type"]="application/xml",n["Content-MD5"]=r.binaryBase64(r.md5(o)),h.call(this,{Action:"name/cos:PutBucketLogging",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:o,action:"logging",headers:n},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketLogging:function(e,t){h.call(this,{Action:"name/cos:GetBucketLogging",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"logging"},function(e,o){if(e)return t(e);t(null,{BucketLoggingStatus:o.BucketLoggingStatus,statusCode:o.statusCode,headers:o.headers})})},putBucketInventory:function(e,t){var o=r.clone(e.InventoryConfiguration);if(o.OptionalFields){var n=o.OptionalFields||[];o.OptionalFields={Field:n}}if(o.Destination&&o.Destination.COSBucketDestination&&o.Destination.COSBucketDestination.Encryption){var a=o.Destination.COSBucketDestination.Encryption;Object.keys(a).indexOf("SSECOS")>-1&&(a["SSE-COS"]=a.SSECOS,delete a.SSECOS)}var s=r.json2xml({InventoryConfiguration:o}),i=e.Headers;i["Content-Type"]="application/xml",i["Content-MD5"]=r.binaryBase64(r.md5(s)),h.call(this,{Action:"name/cos:PutBucketInventory",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:s,action:"inventory",qs:{id:e.Id},headers:i},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketInventory:function(e,t){h.call(this,{Action:"name/cos:GetBucketInventory",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"inventory",qs:{id:e.Id}},function(e,o){if(e)return t(e);var n=o.InventoryConfiguration;if(n&&n.OptionalFields&&n.OptionalFields.Field){var a=n.OptionalFields.Field;r.isArray(a)||(a=[a]),n.OptionalFields=a}if(n.Destination&&n.Destination.COSBucketDestination&&n.Destination.COSBucketDestination.Encryption){var s=n.Destination.COSBucketDestination.Encryption;Object.keys(s).indexOf("SSE-COS")>-1&&(s.SSECOS=s["SSE-COS"],delete s["SSE-COS"])}t(null,{InventoryConfiguration:n,statusCode:o.statusCode,headers:o.headers})})},listBucketInventory:function(e,t){h.call(this,{Action:"name/cos:ListBucketInventory",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"inventory",qs:{"continuation-token":e.ContinuationToken}},function(e,o){if(e)return t(e);var n=o.ListInventoryConfigurationResult,a=n.InventoryConfiguration||[];a=r.isArray(a)?a:[a],delete n.InventoryConfiguration,r.each(a,function(e){if(e&&e.OptionalFields&&e.OptionalFields.Field){var t=e.OptionalFields.Field;r.isArray(t)||(t=[t]),e.OptionalFields=t}if(e.Destination&&e.Destination.COSBucketDestination&&e.Destination.COSBucketDestination.Encryption){var o=e.Destination.COSBucketDestination.Encryption;Object.keys(o).indexOf("SSE-COS")>-1&&(o.SSECOS=o["SSE-COS"],delete o["SSE-COS"])}}),n.InventoryConfigurations=a,r.extend(n,{statusCode:o.statusCode,headers:o.headers}),t(null,n)})},deleteBucketInventory:function(e,t){h.call(this,{Action:"name/cos:DeleteBucketInventory",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"inventory",qs:{id:e.Id}},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},putBucketAccelerate:function(e,t){if(!e.AccelerateConfiguration)return t(r.error(new Error("missing param AccelerateConfiguration"))),void 0;var o={AccelerateConfiguration:e.AccelerateConfiguration||{}},n=r.json2xml(o),a={"Content-Type":"application/xml"};a["Content-MD5"]=r.binaryBase64(r.md5(n)),h.call(this,{Interface:"putBucketAccelerate",Action:"name/cos:PutBucketAccelerate",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:n,action:"accelerate",headers:a},function(e,o){if(e)return t(e);t(null,{statusCode:o.statusCode,headers:o.headers})})},getBucketAccelerate:function(e,t){h.call(this,{Interface:"getBucketAccelerate",Action:"name/cos:GetBucketAccelerate",method:"GET",Bucket:e.Bucket,Region:e.Region,action:"accelerate"},function(e,o){e||!o.AccelerateConfiguration&&(o.AccelerateConfiguration={}),t(e,o)})},getObject:s,getObjectStream:function(e,t){return e.ReturnStream=!0,s.call(this,e,t)},headObject:function(e,t){h.call(this,{Action:"name/cos:HeadObject",method:"HEAD",Bucket:e.Bucket,Region:e.Region,Key:e.Key,VersionId:e.VersionId,headers:e.Headers},function(o,n){if(o){var r=o.statusCode;return e.Headers["If-Modified-Since"]&&r&&304===r?t(null,{NotModified:!0,statusCode:r}):t(o)}n.headers&&n.headers.etag&&(n.ETag=n.headers&&n.headers.etag),t(null,n)})},listObjectVersions:function(e,t){var o={};o.prefix=e.Prefix||"",o.delimiter=e.Delimiter,o["key-marker"]=e.KeyMarker,o["version-id-marker"]=e.VersionIdMarker,o["max-keys"]=e.MaxKeys,o["encoding-type"]=e.EncodingType,h.call(this,{Action:"name/cos:GetBucketObjectVersions",ResourceKey:o.prefix,method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,qs:o,action:"versions"},function(e,o){if(e)return t(e);var n=o.ListVersionsResult||{},a=n.DeleteMarker||[];a=r.isArray(a)?a:[a];var s=n.Version||[];s=r.isArray(s)?s:[s];var i=r.clone(n);delete i.DeleteMarker,delete i.Version,r.extend(i,{DeleteMarkers:a,Versions:s,statusCode:o.statusCode,headers:o.headers}),t(null,i)})},putObject:function(e,t){var o=this,n=e.ContentLength,a=r.throttleOnProgress.call(o,n,e.onProgress),s=e.Headers;s["Cache-Control"]||s["cache-control"]||(s["Cache-Control"]=""),r.getBodyMd5(o.options.UploadCheckContentMd5,e.Body,function(s){s&&(e.Headers["Content-MD5"]=r.binaryBase64(s)),void 0!==e.ContentLength&&(e.Headers["Content-Length"]=e.ContentLength),a(null,!0),h.call(o,{Action:"name/cos:PutObject",TaskId:e.TaskId,method:"PUT",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,qs:e.Query,body:e.Body,onProgress:a},function(r,s){if(r)return a(null,!0),t(r);if(a({loaded:n,total:n},!0),s){var i=d({ForcePathStyle:o.options.ForcePathStyle,protocol:o.options.Protocol,domain:o.options.Domain,bucket:e.Bucket,region:e.Region,object:e.Key});return i=i.substr(i.indexOf("://")+3),s.Location=i,s.headers&&s.headers.etag&&(s.ETag=s.headers.etag),t(null,s)}t(null,s)})})},deleteObject:function(e,t){h.call(this,{Action:"name/cos:DeleteObject",method:"DELETE",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,VersionId:e.VersionId},function(e,o){if(e){var n=e.statusCode;return n&&204===n?t(null,{statusCode:n}):n&&404===n?t(null,{BucketNotFound:!0,statusCode:n}):t(e)}t(null,{statusCode:o.statusCode,headers:o.headers})})},getObjectAcl:function(e,t){h.call(this,{Action:"name/cos:GetObjectACL",method:"GET",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,action:"acl"},function(e,o){if(e)return t(e);var n=o.AccessControlPolicy||{},a=n.Owner||{},s=n.AccessControlList&&n.AccessControlList.Grant||[];s=r.isArray(s)?s:[s];var i=c(n);delete i.GrantWrite,o.headers&&o.headers["x-cos-acl"]&&(i.ACL=o.headers["x-cos-acl"]),i=r.extend(i,{Owner:a,Grants:s,statusCode:o.statusCode,headers:o.headers}),t(null,i)})},putObjectAcl:function(e,t){var o=e.Headers,n="";if(e.AccessControlPolicy){var a=r.clone(e.AccessControlPolicy||{}),s=a.Grants||a.Grant;s=r.isArray(s)?s:[s],delete a.Grant,delete a.Grants,a.AccessControlList={Grant:s},n=r.json2xml({AccessControlPolicy:a}),o["Content-Type"]="application/xml",o["Content-MD5"]=r.binaryBase64(r.md5(n))}r.each(o,function(e,t){0===t.indexOf("x-cos-grant-")&&(o[t]=u(o[t]))}),h.call(this,{Action:"name/cos:PutObjectACL",method:"PUT",Bucket:e.Bucket,Region:e.Region,Key:e.Key,action:"acl",headers:o,body:n},function(e,o){if(e)return t(e);t(null,{statusCode:o.statusCode,headers:o.headers})})},optionsObject:function(e,t){var o=e.Headers;o.Origin=e.Origin,o["Access-Control-Request-Method"]=e.AccessControlRequestMethod,o["Access-Control-Request-Headers"]=e.AccessControlRequestHeaders,h.call(this,{Action:"name/cos:OptionsObject",method:"OPTIONS",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:o},function(e,o){if(e)return e.statusCode&&403===e.statusCode?t(null,{OptionsForbidden:!0,statusCode:e.statusCode}):t(e);var n=o.headers||{};t(null,{AccessControlAllowOrigin:n["access-control-allow-origin"],AccessControlAllowMethods:n["access-control-allow-methods"],AccessControlAllowHeaders:n["access-control-allow-headers"],AccessControlExposeHeaders:n["access-control-expose-headers"],AccessControlMaxAge:n["access-control-max-age"],statusCode:o.statusCode,headers:o.headers})})},putObjectCopy:function(e,t){var o=e.Headers;o["Cache-Control"]||o["cache-control"]||(o["Cache-Control"]="");var n=(e.CopySource||"").match(/^([^.]+-\d+)\.cos(v6)?\.([^.]+)\.[^/]+\/(.+)$/);if(!n)return t(r.error(new Error("CopySource format error"))),void 0;var a=n[1],s=n[3],i=decodeURIComponent(n[4]);h.call(this,{Scope:[{action:"name/cos:GetObject",bucket:a,region:s,prefix:i},{action:"name/cos:PutObject",bucket:e.Bucket,region:e.Region,prefix:e.Key}],method:"PUT",Bucket:e.Bucket,Region:e.Region,Key:e.Key,VersionId:e.VersionId,headers:e.Headers},function(e,o){if(e)return t(e);var n=r.clone(o.CopyObjectResult||{});r.extend(n,{statusCode:o.statusCode,headers:o.headers}),t(null,n)})},deleteMultipleObject:function(e,t){var o=e.Objects||[],n=e.Quiet;o=r.isArray(o)?o:[o];var a=r.json2xml({Delete:{Object:o,Quiet:n||!1}}),s=e.Headers;s["Content-Type"]="application/xml",s["Content-MD5"]=r.binaryBase64(r.md5(a));var i=r.map(o,function(t){return{action:"name/cos:DeleteObject",bucket:e.Bucket,region:e.Region,prefix:t.Key}});h.call(this,{Scope:i,method:"POST",Bucket:e.Bucket,Region:e.Region,body:a,action:"delete",headers:s},function(e,o){if(e)return t(e);var n=o.DeleteResult||{},a=n.Deleted||[],s=n.Error||[];a=r.isArray(a)?a:[a],s=r.isArray(s)?s:[s];var i=r.clone(n);r.extend(i,{Error:s,Deleted:a,statusCode:o.statusCode,headers:o.headers}),t(null,i)})},restoreObject:function(e,t){var o=e.Headers;if(!e.RestoreRequest)return t(r.error(new Error("missing param RestoreRequest"))),void 0;var n=e.RestoreRequest||{},a=r.json2xml({RestoreRequest:n});o["Content-Type"]="application/xml",o["Content-MD5"]=r.binaryBase64(r.md5(a)),h.call(this,{Action:"name/cos:RestoreObject",method:"POST",Bucket:e.Bucket,Region:e.Region,Key:e.Key,VersionId:e.VersionId,body:a,action:"restore",headers:o},t)},putObjectTagging:function(e,t){var o=e.Tagging||{},n=o.TagSet||o.Tags||e.Tags||[];n=r.clone(r.isArray(n)?n:[n]);var a=r.json2xml({Tagging:{TagSet:{Tag:n}}}),s=e.Headers;s["Content-Type"]="application/xml",s["Content-MD5"]=r.binaryBase64(r.md5(a)),h.call(this,{Interface:"putObjectTagging",Action:"name/cos:PutObjectTagging",method:"PUT",Bucket:e.Bucket,Key:e.Key,Region:e.Region,body:a,action:"tagging",headers:s,VersionId:e.VersionId},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getObjectTagging:function(e,t){h.call(this,{Interface:"getObjectTagging",Action:"name/cos:GetObjectTagging",method:"GET",Key:e.Key,Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"tagging",VersionId:e.VersionId},function(e,o){if(e)if(404!==e.statusCode||!e.error||"Not Found"!==e.error&&"NoSuchTagSet"!==e.error.Code)t(e);else{var n={Tags:[],statusCode:e.statusCode};e.headers&&(n.headers=e.headers),t(null,n)}else{var a=[];try{a=o.Tagging.TagSet.Tag||[]}catch(e){}a=r.clone(r.isArray(a)?a:[a]),t(null,{Tags:a,statusCode:o.statusCode,headers:o.headers})}})},deleteObjectTagging:function(e,t){h.call(this,{Interface:"deleteObjectTagging",Action:"name/cos:DeleteObjectTagging",method:"DELETE",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,action:"tagging",VersionId:e.VersionId},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},selectObjectContent:i,selectObjectContentStream:function(e,t){return e.ReturnStream=!0,i.call(this,e,t)},uploadPartCopy:function(e,t){var o=(e.CopySource||"").match(/^([^.]+-\d+)\.cos(v6)?\.([^.]+)\.[^/]+\/(.+)$/);if(!o)return t(r.error(new Error("CopySource format error"))),void 0;var n=o[1],a=o[3],s=decodeURIComponent(o[4]);h.call(this,{Scope:[{action:"name/cos:GetObject",bucket:n,region:a,prefix:s},{action:"name/cos:PutObject",bucket:e.Bucket,region:e.Region,prefix:e.Key}],method:"PUT",Bucket:e.Bucket,Region:e.Region,Key:e.Key,VersionId:e.VersionId,qs:{partNumber:e.PartNumber,uploadId:e.UploadId},headers:e.Headers},function(e,o){if(e)return t(e);var n=r.clone(o.CopyPartResult||{});r.extend(n,{statusCode:o.statusCode,headers:o.headers}),t(null,n)})},multipartInit:function(e,t){var o=e.Headers;o["Cache-Control"]||o["cache-control"]||(o["Cache-Control"]=""),h.call(this,{Action:"name/cos:InitiateMultipartUpload",method:"POST",Bucket:e.Bucket,Region:e.Region,Key:e.Key,action:"uploads",headers:e.Headers,qs:e.Query},function(e,o){return e?t(e):(o=r.clone(o||{}))&&o.InitiateMultipartUploadResult?t(null,r.extend(o.InitiateMultipartUploadResult,{statusCode:o.statusCode,headers:o.headers})):(t(null,o),void 0)})},multipartUpload:function(e,t){var o=this;r.getFileSize("multipartUpload",e,function(){r.getBodyMd5(o.options.UploadCheckContentMd5,e.Body,function(n){n&&(e.Headers["Content-MD5"]=r.binaryBase64(n)),h.call(o,{Action:"name/cos:UploadPart",TaskId:e.TaskId,method:"PUT",Bucket:e.Bucket,Region:e.Region,Key:e.Key,qs:{partNumber:e.PartNumber,uploadId:e.UploadId},headers:e.Headers,onProgress:e.onProgress,body:e.Body||null},function(e,o){if(e)return t(e);o.headers=o.headers||{},t(null,{ETag:o.headers.etag||"",statusCode:o.statusCode,headers:o.headers})})})})},multipartComplete:function(e,t){for(var o=this,n=e.UploadId,a=e.Parts,s=0,i=a.length;s<i;s++)0!==a[s].ETag.indexOf('"')&&(a[s].ETag='"'+a[s].ETag+'"');var c=r.json2xml({CompleteMultipartUpload:{Part:a}});c=c.replace(/\n\s*/g,"");var u=e.Headers;u["Content-Type"]="application/xml",u["Content-MD5"]=r.binaryBase64(r.md5(c)),h.call(this,{Action:"name/cos:CompleteMultipartUpload",method:"POST",Bucket:e.Bucket,Region:e.Region,Key:e.Key,qs:{uploadId:n},body:c,headers:u},function(n,a){if(n)return t(n);var s=d({ForcePathStyle:o.options.ForcePathStyle,protocol:o.options.Protocol,domain:o.options.Domain,bucket:e.Bucket,region:e.Region,object:e.Key,isLocation:!0}),i=a.CompleteMultipartUploadResult||{},c=r.extend(i,{Location:s,statusCode:a.statusCode,headers:a.headers});t(null,c)})},multipartList:function(e,t){var o={};o.delimiter=e.Delimiter,o["encoding-type"]=e.EncodingType,o.prefix=e.Prefix||"",o["max-uploads"]=e.MaxUploads,o["key-marker"]=e.KeyMarker,o["upload-id-marker"]=e.UploadIdMarker,o=r.clearKey(o),h.call(this,{Action:"name/cos:ListMultipartUploads",ResourceKey:o.prefix,method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,qs:o,action:"uploads"},function(e,o){if(e)return t(e);if(o&&o.ListMultipartUploadsResult){var n=o.ListMultipartUploadsResult.Upload||[];n=r.isArray(n)?n:[n],o.ListMultipartUploadsResult.Upload=n}var a=r.clone(o.ListMultipartUploadsResult||{});r.extend(a,{statusCode:o.statusCode,headers:o.headers}),t(null,a)})},multipartListPart:function(e,t){var o={};o.uploadId=e.UploadId,o["encoding-type"]=e.EncodingType,o["max-parts"]=e.MaxParts,o["part-number-marker"]=e.PartNumberMarker,h.call(this,{Action:"name/cos:ListParts",method:"GET",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,qs:o},function(e,o){if(e)return t(e);var n=o.ListPartsResult||{},a=n.Part||[];a=r.isArray(a)?a:[a],n.Part=a;var s=r.clone(n);r.extend(s,{statusCode:o.statusCode,headers:o.headers}),t(null,s)})},multipartAbort:function(e,t){var o={};o.uploadId=e.UploadId,h.call(this,{Action:"name/cos:AbortMultipartUpload",method:"DELETE",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,qs:o},function(e,o){if(e)return t(e);t(null,{statusCode:o.statusCode,headers:o.headers})})},getObjectUrl:function(e,t){var o=d({ForcePathStyle:this.options.ForcePathStyle,protocol:e.Protocol||this.options.Protocol,domain:e.Domain||this.options.Domain,bucket:e.Bucket,region:e.Region,object:e.Key});if(void 0!==e.Sign&&!e.Sign)return t(null,{Url:o}),o;var n=l.call(this,{Action:"PUT"===(e.Method||"").toUpperCase()?"name/cos:PutObject":"name/cos:GetObject",Bucket:e.Bucket||"",Region:e.Region||"",Method:e.Method||"get",Key:e.Key,Expires:e.Expires},function(e,n){if(t){if(e)return t(e),void 0;var r=o;r+="?"+(n.Authorization.indexOf("q-signature")>-1?n.Authorization:"sign="+encodeURIComponent(n.Authorization)),n.SecurityToken&&(r+="&x-cos-security-token="+n.SecurityToken),n.ClientIP&&(r+="&clientIP="+n.ClientIP),n.ClientUA&&(r+="&clientUA="+n.ClientUA),n.Token&&(r+="&token="+n.Token),setTimeout(function(){t(null,{Url:r})})}});return n?o+"?"+n.Authorization+(n.SecurityToken?"&x-cos-security-token="+n.SecurityToken:""):o},getAuth:function(e){return r.getAuth({SecretId:e.SecretId||this.options.SecretId||"",SecretKey:e.SecretKey||this.options.SecretKey||"",Method:e.Method,Key:e.Key,Query:e.Query,Headers:e.Headers,Expires:e.Expires,UseRawKey:this.options.UseRawKey,SystemClockOffset:this.options.SystemClockOffset})},getV4Auth:function(e){return r.getV4Auth({SecretId:e.SecretId||this.options.SecretId||"",SecretKey:e.SecretKey||this.options.SecretKey||"",Bucket:e.Bucket,Key:e.Key,Expires:e.Expires})}};module.exports.init=function(e,t){t.transferToTaskMethod(g,"putObject"),r.each(g,function(t,o){e.prototype[o]=r.apiWrapper(o,t),function(e,t,o){r.each(["Cors","Acl"],function(n){if(e.slice(-n.length)===n){var a=e.slice(0,-n.length)+n.toUpperCase(),s=r.apiWrapper(e,t),i=!1;o[a]=function(){!i&&console.warn("warning: cos."+a+" has been deprecated. Please Use cos."+e+" instead."),i=!0,s.apply(this,arguments)}}})}(o,t,e.prototype)})};