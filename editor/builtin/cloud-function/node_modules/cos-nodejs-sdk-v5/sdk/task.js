var a=require("./session"),e=require("./util"),t={};module.exports.transferToTaskMethod=function(a,e){t[e]=a[e],a[e]=function(a,n){a.SkipTask?t[e].call(this,a,n):this._addTask(e,a,n)}},module.exports.init=function(n){var s=[],i={},r=0,o=0,d=function(a){var e={id:a.id,Bucket:a.Bucket,Region:a.Region,Key:a.Key,FilePath:a.FilePath,state:a.state,loaded:a.loaded,size:a.size,speed:a.speed,percent:a.percent,hashPercent:a.hashPercent,error:a.error};return a.FilePath&&(e.FilePath=a.FilePath),e},c=function(){var a,t=function(){a=0,n.emit("task-list-update",{list:e.map(s,d)}),n.emit("list-update",{list:e.map(s,d)})};return function(){a||(a=setTimeout(t))}}(),l=function(){if(!(s.length<=n.options.UploadQueueSize)){for(var a=0;a<o&&a<s.length&&s.length>n.options.UploadQueueSize;){var e="waiting"===s[a].state||"checking"===s[a].state||"uploading"===s[a].state;s[a]&&e?a++:(i[s[a].id]&&delete i[s[a].id],s.splice(a,1),o--)}c()}},p=function(){if(!(r>=n.options.FileParallelLimit)){for(;s[o]&&"waiting"!==s[o].state;)o++;if(!(o>=s.length)){var a=s[o];o++,r++,a.state="checking",a.params.onTaskStart&&a.params.onTaskStart(d(a)),!a.params.UploadData&&(a.params.UploadData={});var i=e.formatParams(a.api,a.params);t[a.api].call(n,i,function(e,t){n._isRunningTask(a.id)&&("checking"!==a.state&&"uploading"!==a.state||(a.state=e?"error":"success",e&&(a.error=e),r--,c(),p(),a.callback&&a.callback(e,t),"success"===a.state&&(a.params&&(delete a.params.UploadData,delete a.params.Body,delete a.params),delete a.callback)),l())}),c(),setTimeout(p)}}},u=function(e,t){var s=i[e];if(s){var o=s&&"waiting"===s.state,d=s&&("checking"===s.state||"uploading"===s.state);if("canceled"===t&&"canceled"!==s.state||"paused"===t&&o||"paused"===t&&d){if("paused"===t&&s.params.Body&&"function"==typeof s.params.Body.pipe)return console.error("stream not support pause"),void 0;s.state=t,n.emit("inner-kill-task",{TaskId:e,toState:t});try{var u=s&&s.params&&s.params.UploadData.UploadId}catch(a){}"canceled"===t&&u&&a.removeUsing(u),c(),d&&(r--,p()),"canceled"===t&&(s.params&&(delete s.params.UploadData,delete s.params.Body,delete s.params),delete s.callback)}l()}};n._addTasks=function(a){e.each(a,function(a){n._addTask(a.api,a.params,a.callback,!0)}),c()};var k=!0;n._addTask=function(a,t,r,o){t=e.formatParams(a,t);var d=e.uuid();t.TaskId=d,t.onTaskReady&&t.onTaskReady(d),t.TaskReady&&(t.TaskReady(d),k&&console.warn('warning: Param "TaskReady" has been deprecated. Please use "onTaskReady" instead.'),k=!1);var u={params:t,callback:r,api:a,index:s.length,id:d,Bucket:t.Bucket,Region:t.Region,Key:t.Key,FilePath:t.FilePath||"",state:"waiting",loaded:0,size:0,speed:0,percent:0,hashPercent:0,error:null},g=t.onHashProgress;t.onHashProgress=function(a){n._isRunningTask(u.id)&&(u.hashPercent=a.percent,g&&g(a),c())};var m=t.onProgress;return t.onProgress=function(a){n._isRunningTask(u.id)&&("checking"===u.state&&(u.state="uploading"),u.loaded=a.loaded,u.speed=a.speed,u.percent=a.percent,m&&m(a),c())},e.getFileSize(a,t,function(a,t){if(a)return r(e.error(a));i[d]=u,s.push(u),u.size=t,!o&&c(),p(),l()}),d},n._isRunningTask=function(a){var e=i[a];return!(!e||"checking"!==e.state&&"uploading"!==e.state)},n.getTaskList=function(){return e.map(s,d)},n.cancelTask=function(a){u(a,"canceled")},n.pauseTask=function(a){u(a,"paused")},n.restartTask=function(a){var e=i[a];!e||"paused"!==e.state&&"error"!==e.state||(e.state="waiting",c(),o=Math.min(o,e.index),p())},n.isUploadRunning=function(){return r||o<s.length}};