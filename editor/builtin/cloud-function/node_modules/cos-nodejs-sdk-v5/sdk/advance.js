var e=require("./session"),t=require("fs"),i=require("./async"),n=require("./event").EventProxy,o=require("./util");function r(e,t){var i=this,n=[],o={Bucket:e.Bucket,Region:e.Region,Prefix:e.Key},r=function(){i.multipartList(o,function(e,i){if(e)return t(e);n.push.apply(n,i.Upload||[]),"true"===i.IsTruncated?(o.KeyMarker=i.NextKeyMarker,o.UploadIdMarker=i.NextUploadIdMarker,r()):t(null,{UploadList:n})})};r()}function a(e,t){var i=this,n=[],o={Bucket:e.Bucket,Region:e.Region,Key:e.Key,UploadId:e.UploadId},r=function(){i.multipartListPart(o,function(e,i){if(e)return t(e);n.push.apply(n,i.Part||[]),"true"===i.IsTruncated?(o.PartNumberMarker=i.NextPartNumberMarker,r()):t(null,{PartList:n})})};r()}var l={sliceUploadFile:function(t,l){var s,u,d=this,c=new n,p=t.TaskId,f=t.Bucket,g=t.Region,h=t.Key,_=t.FilePath,m=t.ChunkSize||t.SliceSize||d.options.ChunkSize,y=t.AsyncLimit,k=t.StorageClass,v=t.ServerSideEncryption,S=t.onHashProgress;c.on("error",function(e){if(d._isRunningTask(p))return l(e)}),c.on("upload_complete",function(e){l(null,e)}),c.on("upload_slice_complete",function(t){(function(e,t){var n=e.Bucket,o=e.Region,r=e.Key,a=e.UploadId,l=e.SliceList,s=this,u=this.options.ChunkRetryTimes+1,d=l.map(function(e){return{PartNumber:e.PartNumber,ETag:e.ETag}});i.retry(u,function(e){s.multipartComplete({Bucket:n,Region:o,Key:r,UploadId:a,Parts:d},e)},function(e,i){t(e,i)})}).call(d,{Bucket:f,Region:g,Key:h,UploadId:t.UploadId,SliceList:t.SliceList},function(i,n){if(d._isRunningTask(p)){if(e.removeUsing(t.UploadId),i)return u(null,!0),c.emit("error",i);e.removeUploadId.call(d,t.UploadId),u({loaded:s,total:s},!0),c.emit("upload_complete",n)}})}),c.on("get_upload_data_finish",function(n){var r=e.getFileId(t.FileStat,t.ChunkSize,f,h);r&&e.saveUploadId.call(d,r,n.UploadId,d.options.UploadIdCacheLimit),e.setUsing(n.UploadId),u(null,!0),function(e,t){var n=this,r=e.TaskId,a=e.Bucket,l=e.Region,s=e.Key,u=e.UploadData,d=e.FileSize,c=e.SliceSize,p=Math.min(e.AsyncLimit||n.options.ChunkParallelLimit||1,256),f=e.FilePath,g=Math.ceil(d/c),h=0,_=e.ServerSideEncryption,m=o.filter(u.PartList,function(e){return e.Uploaded&&(h+=e.PartNumber>=g&&d%c||c),!e.Uploaded}),y=e.onProgress;i.eachLimit(m,p,function(e,t){if(n._isRunningTask(r)){var p=e.PartNumber,g=Math.min(d,e.PartNumber*c)-(e.PartNumber-1)*c,m=0;(function(e,t){var n=this,r=e.TaskId,a=e.Bucket,l=e.Region,s=e.Key,u=e.FileSize,d=e.FilePath,c=1*e.PartNumber,p=e.SliceSize,f=e.ServerSideEncryption,g=e.UploadData,h=n.options.ChunkRetryTimes+1,_=p*(c-1),m=p,y=_+p;y>u&&(m=(y=u)-_),o.fileSlice(d,_,y,function(u){o.getFileMd5(u,function(u,p){var k=p?o.binaryBase64(p):"",v=g.PartList[c-1];i.retry(h,function(t){n._isRunningTask(r)&&o.fileSlice(d,_,y,function(i){n.multipartUpload({TaskId:r,Bucket:a,Region:l,Key:s,ContentLength:m,PartNumber:c,UploadId:g.UploadId,ServerSideEncryption:f,Body:i,onProgress:e.onProgress,ContentMD5:k},function(e,i){if(n._isRunningTask(r))return e?t(e):(v.Uploaded=!0,t(null,i))})})},function(e,i){if(n._isRunningTask(r))return t(e,i)})})})}).call(n,{TaskId:r,Bucket:a,Region:l,Key:s,SliceSize:c,FileSize:d,PartNumber:p,ServerSideEncryption:_,FilePath:f,UploadData:u,onProgress:function(e){h+=e.loaded-m,m=e.loaded,y({loaded:h,total:d})}},function(i,o){n._isRunningTask(r)&&(i?h-=m:(h+=g-m,e.ETag=o.ETag),y({loaded:h,total:d}),t(i||null,o))})}},function(e){if(n._isRunningTask(r))return e?t(e):(t(null,{UploadId:u.UploadId,SliceList:u.PartList}),void 0)})}.call(d,{TaskId:p,Bucket:f,Region:g,Key:h,FilePath:_,FileSize:s,SliceSize:m,AsyncLimit:y,ServerSideEncryption:v,UploadData:n,onProgress:u},function(e,t){if(d._isRunningTask(p))return e?(u(null,!0),c.emit("error",e)):(c.emit("upload_slice_complete",t),void 0)})}),c.on("get_file_size_finish",function(){if(u=o.throttleOnProgress.call(d,s,t.onProgress),t.UploadData.UploadId)c.emit("get_upload_data_finish",t.UploadData);else{var l=o.extend({TaskId:p,Bucket:f,Region:g,Key:h,Headers:t.Headers,StorageClass:k,FilePath:_,FileSize:s,SliceSize:m,onHashProgress:S},t);(function(t,l){var s=t.TaskId,u=t.Bucket,d=t.Region,c=t.Key,p=t.StorageClass,f=this,g={},h=t.FileSize,_=t.SliceSize,m=Math.ceil(h/_),y=0,k=o.throttleOnProgress.call(f,h,t.onHashProgress),v=function(e,i){var n=e.length;if(0===n)return i(null,!0);if(n>m)return i(null,!1);if(n>1){var r=Math.max(e[0].Size,e[1].Size);if(r!==_)return i(null,!1)}var a=function(r){if(r<n){var l=e[r];(function(e,i){var n=_*(e-1),r=Math.min(n+_,h),a=r-n;g[e]?i(null,{PartNumber:e,ETag:g[e],Size:a}):o.fileSlice(t.FilePath,n,r,function(t){o.getFileMd5(t,function(t,n){if(t)return i(o.error(t));var r='"'+n+'"';g[e]=r,1,k({loaded:y+=a,total:h}),i(null,{PartNumber:e,ETag:r,Size:a})})})})(l.PartNumber,function(e,t){t&&t.ETag===l.ETag&&t.Size===l.Size?a(r+1):i(null,!1)})}else i(null,!0)};a(0)},S=new n;S.on("error",function(e){if(f._isRunningTask(s))return l(e)}),S.on("upload_id_available",function(e){var t={},i=[];o.each(e.PartList,function(e){t[e.PartNumber]=e});for(var n=1;n<=m;n++){var r=t[n];r?(r.PartNumber=n,r.Uploaded=!0):r={PartNumber:n,ETag:null,Uploaded:!1},i.push(r)}e.PartList=i,l(null,e)}),S.on("no_available_upload_id",function(){if(f._isRunningTask(s)){var e=o.extend({Bucket:u,Region:d,Key:c,Headers:o.clone(t.Headers),Query:o.clone(t.Query),StorageClass:p},t);f.multipartInit(e,function(e,t){if(f._isRunningTask(s)){if(e)return S.emit("error",e);var i=t.UploadId;if(!i)return l(o.error(new Error("no such upload id")));S.emit("upload_id_available",{UploadId:i,PartList:[]})}})}}),S.on("has_and_check_upload_id",function(t){t=t.reverse(),i.eachLimit(t,1,function(t,i){if(f._isRunningTask(s))return e.using[t]?(i(),void 0):(a.call(f,{Bucket:u,Region:d,Key:c,UploadId:t},function(n,o){if(f._isRunningTask(s)){if(n)return e.removeUsing(t),S.emit("error",n);var r=o.PartList;r.forEach(function(e){e.PartNumber*=1,e.Size*=1,e.ETag=e.ETag||""}),v(r,function(e,n){if(f._isRunningTask(s))return e?S.emit("error",e):(n?i({UploadId:t,PartList:r}):i(),void 0)})}}),void 0)},function(e){f._isRunningTask(s)&&(k(null,!0),e&&e.UploadId?S.emit("upload_id_available",e):S.emit("no_available_upload_id"))})}),S.on("seek_local_avail_upload_id",function(i){var n=e.getFileId(t.FileStat,t.ChunkSize,u,c),r=e.getUploadIdList.call(f,n);if(!n||!r)return S.emit("has_and_check_upload_id",i),void 0;var l=function(t){if(t>=r.length)return S.emit("has_and_check_upload_id",i),void 0;var n=r[t];return o.isInArray(i,n)?e.using[n]?(l(t+1),void 0):(a.call(f,{Bucket:u,Region:d,Key:c,UploadId:n},function(i,o){f._isRunningTask(s)&&(i?(e.removeUploadId.call(f,n),l(t+1)):S.emit("upload_id_available",{UploadId:n,PartList:o.PartList}))}),void 0):(e.removeUploadId.call(f,n),l(t+1),void 0)};l(0)}),S.on("get_remote_upload_id_list",function(){r.call(f,{Bucket:u,Region:d,Key:c},function(i,n){if(f._isRunningTask(s)){if(i)return S.emit("error",i);var r=o.filter(n.UploadList,function(e){return e.Key===c&&(!p||e.StorageClass.toUpperCase()===p.toUpperCase())}).reverse().map(function(e){return e.UploadId||e.UploadID});if(r.length)S.emit("seek_local_avail_upload_id",r);else{var a,l=e.getFileId(t.FileStat,t.ChunkSize,u,c);l&&(a=e.getUploadIdList.call(f,l))&&o.each(a,function(t){e.removeUploadId.call(f,t)}),S.emit("no_available_upload_id")}}})}),S.emit("get_remote_upload_id_list")}).call(d,l,function(e,i){if(d._isRunningTask(p)){if(e)return c.emit("error",e);t.UploadData.UploadId=i.UploadId,t.UploadData.PartList=i.PartList,c.emit("get_upload_data_finish",t.UploadData)}})}}),s=t.ContentLength,delete t.ContentLength,!t.Headers&&(t.Headers={}),o.each(t.Headers,function(e,i){"content-length"===i.toLowerCase()&&delete t.Headers[i]}),function(){for(var e=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,5120],i=1048576,n=0;n<e.length&&!(s/(i=1024*e[n]*1024)<=d.options.MaxPartNumber);n++);t.ChunkSize=t.SliceSize=m=Math.max(m,i)}(),0===s?(t.Body="",t.ContentLength=0,t.SkipTask=!0,d.putObject(t,l)):c.emit("get_file_size_finish")},abortUploadTask:function(e,t){var a=e.Bucket,l=e.Region,s=e.Key,u=e.UploadId,d=e.Level||"task",c=e.AsyncLimit,p=this,f=new n;if(f.on("error",function(e){return t(e)}),f.on("get_abort_array",function(n){(function(e,t){var n=e.Bucket,o=e.Region,r=e.Key,a=e.AbortArray,l=e.AsyncLimit||1,s=this,u=0,d=new Array(a.length);i.eachLimit(a,l,function(t,i){var a=u;if(r&&r!==t.Key)return d[a]={error:{KeyNotMatch:!0}},i(null),void 0;var l=t.UploadId||t.UploadID;s.multipartAbort({Bucket:n,Region:o,Key:t.Key,Headers:e.Headers,UploadId:l},function(e){var r={Bucket:n,Region:o,Key:t.Key,UploadId:l};d[a]={error:e,task:r},i(null)}),u++},function(e){if(e)return t(e);for(var i=[],n=[],o=0,r=d.length;o<r;o++){var a=d[o];a.task&&(a.error?n.push(a.task):i.push(a.task))}return t(null,{successList:i,errorList:n})})}).call(p,{Bucket:a,Region:l,Key:s,Headers:e.Headers,AsyncLimit:c,AbortArray:n},t)}),"bucket"===d)r.call(p,{Bucket:a,Region:l},function(e,i){if(e)return t(e);f.emit("get_abort_array",i.UploadList||[])});else if("file"===d){if(!s)return t(o.error(new Error("abort_upload_task_no_key")));r.call(p,{Bucket:a,Region:l,Key:s},function(e,i){if(e)return t(e);f.emit("get_abort_array",i.UploadList||[])})}else{if("task"!==d)return t(o.error(new Error("abort_unknown_level")));if(!u)return t(o.error(new Error("abort_upload_task_no_id")));if(!s)return t(o.error(new Error("abort_upload_task_no_key")));f.emit("get_abort_array",[{Key:s,UploadId:u}])}},uploadFiles:function(e,i){var n=this,r=void 0===e.SliceSize?n.options.SliceSize:e.SliceSize,a=0,l=0,s=o.throttleOnProgress.call(n,l,e.onProgress),u=e.files.length,d=e.onFileFinish,c=Array(u),p=function(e,t,n){s(null,!0),d&&d(e,t,n),c[n.Index]={options:n,error:e,data:t},--u<=0&&i&&i(null,{files:c})},f=[],g=e.files.length;o.each(e.files,function(e,i){t.stat(e.FilePath,function(u,d){var c=e.ContentLength=d.size||0,h={Index:i,TaskId:""};a+=c,o.each(e,function(e,t){"object"!=typeof e&&"function"!=typeof e&&(h[t]=e)});var _=e.onTaskReady;e.onTaskReady=function(e){h.TaskId=e,_&&_(e)};var m=0,y=e.onProgress;e.onProgress=function(e){l=l-m+e.loaded,m=e.loaded,y&&y(e),s({loaded:l,total:a})};var k=e.onFileFinish,v=c>r?"sliceUploadFile":"putObject";"putObject"===v&&(e.Body=t.createReadStream(e.FilePath),e.Body.isSdkCreated=!0),f.push({api:v,params:e,callback:function(e,t){k&&k(e,t),p&&p(e,t,h)}}),0==--g&&n._addTasks(f)})})},sliceCopyFile:function(e,t){var r=new n,a=this,l=e.Bucket,s=e.Region,u=e.Key,d=e.CopySource,c=d.match(/^([^.]+-\d+)\.cos(v6)?\.([^.]+)\.[^/]+\/(.+)$/);if(!c)return t(o.error(new Error("CopySource format error"))),void 0;var p=c[1],f=c[3],g=decodeURIComponent(c[4]),h=void 0===e.CopySliceSize?a.options.CopySliceSize:e.CopySliceSize;h=Math.max(0,h);var _,m,y=e.CopyChunkSize||this.options.CopyChunkSize,k=this.options.CopyChunkParallelLimit,v=0;r.on("copy_slice_complete",function(e){var i=o.map(e.PartList,function(e){return{PartNumber:e.PartNumber,ETag:e.ETag}});a.multipartComplete({Bucket:l,Region:s,Key:u,UploadId:e.UploadId,Parts:i},function(e,i){if(e)return m(null,!0),t(e);m({loaded:_,total:_},!0),t(null,i)})}),r.on("get_copy_data_finish",function(e){i.eachLimit(e.PartList,k,function(t,n){var o=t.PartNumber,r=t.CopySourceRange,c=t.end-t.start,p=0;(function(e,t){var n=e.TaskId,o=e.Bucket,r=e.Region,a=e.Key,l=e.CopySource,s=e.UploadId,u=1*e.PartNumber,d=e.CopySourceRange,c=this.options.ChunkRetryTimes+1,p=this;i.retry(c,function(t){p.uploadPartCopy({TaskId:n,Bucket:o,Region:r,Key:a,CopySource:l,UploadId:s,PartNumber:u,CopySourceRange:d,onProgress:e.onProgress},function(e,i){t(e||null,i)})},function(e,i){return t(e,i)})}).call(a,{Bucket:l,Region:s,Key:u,CopySource:d,UploadId:e.UploadId,PartNumber:o,CopySourceRange:r,onProgress:function(e){v+=e.loaded-p,p=e.loaded,m({loaded:v,total:_})}},function(e,i){if(e)return n(e);m({loaded:v,total:_}),v+=c-p,t.ETag=i.ETag,n(e||null,i)})},function(i){if(i)return m(null,!0),t(i);r.emit("copy_slice_complete",e)})}),r.on("get_file_size_finish",function(i){var n;if(function(){for(var t=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,5120],i=1048576,n=0;n<t.length&&!(_/(i=1024*t[n]*1024)<=a.options.MaxPartNumber);n++);e.ChunkSize=y=Math.max(y,i);for(var o=Math.ceil(_/y),r=[],l=1;l<=o;l++){var s=(l-1)*y,u=l*y<_?l*y-1:_-1,d={PartNumber:l,start:s,end:u,CopySourceRange:"bytes="+s+"-"+u};r.push(d)}e.PartList=r}(),(n="Replaced"===e.Headers["x-cos-metadata-directive"]?e.Headers:i)["x-cos-storage-class"]=e.Headers["x-cos-storage-class"]||i["x-cos-storage-class"],n=o.clearKey(n),"ARCHIVE"===i["x-cos-storage-class"]||"DEEP_ARCHIVE"===i["x-cos-storage-class"]){var d=i["x-cos-restore"];if(!d||'ongoing-request="true"'===d)return t(o.error(new Error("Unrestored archive object is not allowed to be copied"))),void 0}delete n["x-cos-copy-source"],delete n["x-cos-metadata-directive"],delete n["x-cos-copy-source-If-Modified-Since"],delete n["x-cos-copy-source-If-Unmodified-Since"],delete n["x-cos-copy-source-If-Match"],delete n["x-cos-copy-source-If-None-Match"],a.multipartInit({Bucket:l,Region:s,Key:u,Headers:n},function(i,n){if(i)return t(i);e.UploadId=n.UploadId,r.emit("get_copy_data_finish",e)})}),a.headObject({Bucket:p,Region:f,Key:g},function(i,n){if(i)return i.statusCode&&404===i.statusCode?t(o.error(i,{ErrorStatus:g+" Not Exist"})):t(i),void 0;if(void 0===(_=e.FileSize=n.headers["content-length"])||!_)return t(o.error(new Error('get Content-Length error, please add "Content-Length" to CORS ExposeHeader setting.'))),void 0;if(m=o.throttleOnProgress.call(a,_,e.onProgress),_<=h)e.Headers["x-cos-metadata-directive"]||(e.Headers["x-cos-metadata-directive"]="Copy"),a.putObjectCopy(e,function(e,i){if(e)return m(null,!0),t(e);m({loaded:_,total:_},!0),t(e,i)});else{var l=n.headers,s={"Cache-Control":l["cache-control"],"Content-Disposition":l["content-disposition"],"Content-Encoding":l["content-encoding"],"Content-Type":l["content-type"],Expires:l.expires,"x-cos-storage-class":l["x-cos-storage-class"]};o.each(l,function(e,t){0===t.indexOf("x-cos-meta-")&&t.length>"x-cos-meta-".length&&(s[t]=e)}),r.emit("get_file_size_finish",s)}})}};module.exports.init=function(e,t){t.transferToTaskMethod(l,"sliceUploadFile"),o.each(l,function(t,i){e.prototype[i]=o.apiWrapper(i,t)})};