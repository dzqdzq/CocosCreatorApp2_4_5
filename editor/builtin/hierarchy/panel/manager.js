"use strict";const e=require("./utils/cache"),i=require("./utils/operation");let t=e.queryCache(),n=[],d=!0;let o=function(o){let l={},r=[],c=[];function f(d,o,u){if(l[d.id]={node:d,parent:u},t[d.id]&&function(i,d,o){let l=t[i.id],r=t[d];if(d!==l.parent)return c=e.remove(i.id),void 0;if(r&&r.children[o]!==i.id){c=e.remove(i.id);let t=n.indexOf(i.id);return-1!==t&&n.splice(t,1),void 0}if(null===d&&n[o]!==i.id){c=e.remove(i.id);let t=n.indexOf(i.id);return-1!==t&&n.splice(t,1),void 0}let f=e.queryNode(i.id);f.name!==i.name&&(f.name=i.name),f.isActive!==i.isActive&&(f.isActive=i.isActive),f.prefabState!==i.prefabState&&(f.prefabState=i.prefabState),f.locked!==i.locked&&(f.locked=i.locked)}(d,u,o),!t[d.id]){(function(e,i){for(let t=0;t<e.length;++t){let n=e[t];n&&n.id===i.id&&(i.fold=n.oldNode.fold,e.splice(t,1))}})(c,d),e.add(d,u||null,o);let t=e.queryNode(u);t&&i.fold(u,t.fold),null===u&&n.splice(o,0,d.id),r.push(d.id)}let s=0;d.children&&d.children.forEach(e=>{e.hidden||f(e,s++,d.id)})}let u=0;if(o.forEach(e=>{e.hidden||f(e,u++,null)}),r.length>0){if(d)return d=!1,void 0;let t=e.queryNode(r[0]);t.parent&&i.fold(t.parent,!1)}let s=[];Object.keys(t).forEach(i=>{if(-1===s.indexOf(i)&&!l[i]){(c=e.remove(i)).forEach(e=>{s.push(e.id)});let t=n.indexOf(i);-1!==t&&n.splice(t,1)}})},l=null,r=function(){Editor.Ipc.sendToPanel("scene","scene:query-hierarchy",(e,i,t)=>{e&&Editor.warn(e),t&&o(t),l=setTimeout(()=>{r()},300)},-1)};exports.startup=function(){e.initNodeState(),d=!0,r()},exports.stop=function(){d=!0,e.initNodeState(),clearTimeout(l),o([])},exports.reset=function(){},exports.deleteNode=function(e){Editor.Selection.unselect("node",e,!0),Editor.Ipc.sendToPanel("scene","scene:delete-nodes",e)};